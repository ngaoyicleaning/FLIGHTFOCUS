<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlight - Premium Flight Simulator Timer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --bg: #0f1724;
            --muted: #9aa4b2;
            --glass: rgba(255,255,255,0.06);
            --accent: linear-gradient(90deg,#ffd166 0%,#ff8a65 40%,#7c4dff 100%);
            --gold: #d4af37;
            --card-radius: 18px;
            --edge: 4px;
        }
        
        body { 
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(124,77,255,0.08), transparent),
                        radial-gradient(900px 500px at 90% 90%, rgba(255,138,101,0.06), transparent),
                        var(--bg);
            color: #e6eef6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .glass-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 8px 30px rgba(2,6,23,0.6);
        }
        
        .mode-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .pomodoro-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        * { transition: all 0.3s ease-in-out; }
        
        #map { 
            height: 400px; 
            border-radius: 1rem; 
            z-index: 10;
            box-shadow: 0 8px 30px rgba(2,6,23,0.6);
            border: 1px solid rgba(255,255,255,0.06);
        }
        
        .leaflet-pane { z-index: 10; }
        .leaflet-tile-pane { z-index: 5; }
        
        .plane-icon { 
            transition: transform 2s ease-in-out; 
            filter: drop-shadow(0 0 5px rgba(14, 165, 233, 0.5));
        }
        
        /* Hide/show views */
        .hidden-view { display: none; }
        
        .flight-card:hover .flight-icon {
            transform: translateX(5px);
        }
        
        .seat {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 5px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        
        .seat.selected {
            background-color: var(--primary);
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }
        
        .seat.occupied {
            background-color: rgba(239, 68, 68, 0.3);
            cursor: not-allowed;
            position: relative;
            overflow: hidden;
        }
        
        .seat.occupied:after {
            content: "âœ—";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(239, 68, 68, 0.8);
            font-size: 18px;
            font-weight: bold;
        }
        
        .seat.first-class {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #1e293b;
            border: 1px solid #f59e0b;
        }
        
        .seat.first-class.selected {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.7);
            color: #1e293b;
        }
        
        .seat.first-class.occupied {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.3));
            color: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(245, 158, 11, 0.5);
        }
        
        .aisle {
            width: 40px;
            height: 40px;
            margin: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: #0f172a;
            padding: 0;
            margin: 0;
        }
        
        .fullscreen-active > div {
            height: 100vh;
            border-radius: 0;
            padding: 2rem;
        }
        
        .fullscreen-active #map {
            height: 60vh;
        }
        
        .mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .mode-toggle button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .mode-toggle button.active {
            background: var(--primary);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(90deg);
            transform-origin: 50% 50%;
        }
        
        .flight-path {
            stroke-dasharray: 10, 5;
            animation: dash 20s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            filter: blur(5px);
            z-index: 1;
        }
        
        .cloud-1 { width: 80px; height: 30px; top: 20%; left: 10%; }
        .cloud-2 { width: 120px; height: 40px; top: 40%; left: 60%; }
        .cloud-3 { width: 100px; height: 35px; top: 70%; left: 30%; }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        
        /* Map enhancements */
        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(15, 23, 42, 0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .map-controls button {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        
        .map-controls button:hover {
            background: rgba(30, 41, 59, 0.9);
        }
        
        .airport-marker {
            background: rgba(14, 165, 233, 0.2);
            border: 2px solid #0ea5e9;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .flight-info-panel {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
        }
        
        .map-legend {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(15, 23, 42, 0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .weather-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .weather-icon {
            position: absolute;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.7);
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
        }
        
        .time-of-day {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
            transition: background 2s ease;
        }
        
        .flight-path-glow {
            filter: drop-shadow(0 0 8px rgba(14, 165, 233, 0.7));
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(14, 165, 233, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 2000;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.hidden {
            display: none;
        }
        
        /* Boarding Pass Styles */
        .pass {
            width: 100%;
            border-radius: var(--card-radius);
            overflow: hidden;
            display: flex;
            gap: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.06);
            position: relative;
            min-height: 180px;
        }

        /* Left side common */
        .pass .left {
            width: 62%;
            padding: 20px 22px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .pass .right {
            width: 38%;
            padding: 18px 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .logo {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 20px;
            letter-spacing: 0.6px;
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.04);
        }
        .brand h3 {
            margin: 0;
            font-size: 18px;
        }
        .brand p {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
        }

        .route {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .route .code {
            font-weight: 800;
            font-size: 34px;
            letter-spacing: 0.6px;
        }
        .route .city {
            color: var(--muted);
            font-size: 13px;
        }

        .meta {
            display: flex;
            gap: 14px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .meta .item {
            min-width: 120px;
        }
        .meta .label {
            font-size: 11px;
            color: var(--muted);
        }
        .meta .value {
            font-weight: 700;
            font-size: 15px;
        }

        .pass.first {
            background: linear-gradient(90deg, rgba(253,230,138,0.06), rgba(255,138,101,0.03));
            border: 1px solid rgba(212,175,55,0.14);
        }
        .pass.first .logo {
            background: linear-gradient(90deg,#fff8e1, #fff3e0);
            color: #111;
        }
        .pass.first .accent {
            background: var(--accent);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 900;
        }
        .pass.first .tag {
            background: linear-gradient(90deg,#fff4cc, #ffe6cc);
            color: #2b1a00;
            padding: 6px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
        }

        .pass.economy {
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
        }
        .pass.economy .logo {
            background: rgba(255,255,255,0.02);
        }
        .pass.economy .tag {
            background: rgba(255,255,255,0.02);
            color: var(--muted);
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 700;
        }

        /* Perforation */
        .perforation {
            position: absolute;
            right: 38%;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(#2b3440 0%, transparent 0%);
            background-size: 1px 12px;
            opacity: 0.12;
        }

        /* QR and small details */
        .qr {
            width: 86px;
            height: 86px;
            background: repeating-conic-gradient(#111 0 10deg, transparent 10deg 20deg);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #111;
            font-weight: 800;
        }

        .footer-note {
            font-size: 12px;
            color: var(--muted);
        }

        /* Points System */
        .points-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .points-display i {
            color: #f59e0b;
        }
        
        .flight-card.locked {
            opacity: 0.6;
            position: relative;
            cursor: not-allowed;
        }
        
        .flight-card.locked:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 1rem;
        }
        
        .lock-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            color: white;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.7);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .points-required {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(245, 158, 11, 0.9);
            color: #1e293b;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            z-index: 10;
        }
        
        .unlock-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.95);
            padding: 30px;
            border-radius: 16px;
            z-index: 3000;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(245, 158, 11, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .unlock-notification.hidden {
            display: none;
        }
        
        .unlock-icon {
            font-size: 48px;
            color: #f59e0b;
            margin-bottom: 15px;
        }

        /* Flight Tracking Mechanism Styles */
        .tracking-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            display: flex;
            gap: 15px;
        }
        
        .overlay-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tracking-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .tracking-off {
            background: #FF5722;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }
        
        .zoom-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .zoom-btn:hover {
            background: white;
            transform: scale(1.05);
        }
        
        /* Custom Boeing 747 plane icon */
        .boeing-icon {
            background: none;
            border: none;
        }
        
        .boeing-icon div {
            width: 40px;
            height: 20px;
            background: #2196F3;
            clip-path: polygon(0% 50%, 5% 40%, 10% 30%, 15% 25%, 20% 20%, 80% 20%, 85% 25%, 90% 30%, 95% 40%, 100% 50%, 95% 60%, 90% 70%, 85% 75%, 80% 80%, 20% 80%, 15% 75%, 10% 70%, 5% 60%);
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.7);
            transform: rotate(0deg);
            transition: transform 0.2s ease;
            position: relative;
        }
        
        .boeing-icon div:before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFC107;
            border-radius: 50%;
            top: 6px;
            left: 10px;
        }
        
        .boeing-icon div:after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFC107;
            border-radius: 50%;
            top: 6px;
            right: 10px;
        }
        
        /* Airport markers */
        .airport-marker {
            background: #FF5722;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .flight-path {
            stroke-dasharray: 10, 10;
        }

        /* Light mode styles */
        body.light-mode {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #1e293b;
        }
        
        body.light-mode .glass-card {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }
        
        body.light-mode .pass {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }
        
        body.light-mode .pass.first {
            background: linear-gradient(90deg, rgba(253,230,138,0.3), rgba(255,138,101,0.2));
            border: 1px solid rgba(212,175,55,0.3);
        }
        
        body.light-mode .pass.economy {
            background: rgba(255, 255, 255, 0.8);
        }
        
        body.light-mode .tracking-overlay {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
        }
        
        body.light-mode .map-overlay,
        body.light-mode .map-legend,
        body.light-mode .flight-info-panel {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .map-controls button {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .points-display {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .notification {
            background: rgba(14, 165, 233, 0.9);
            color: white;
        }
        
        body.light-mode .seat {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }
        
        body.light-mode .seat.selected {
            background-color: var(--primary);
            color: white;
        }
        
        body.light-mode .seat.occupied {
            background-color: rgba(239, 68, 68, 0.2);
            color: rgba(30, 41, 59, 0.5);
        }
        
        body.light-mode .seat.first-class {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #1e293b;
            border: 1px solid #f59e0b;
        }
        
        body.light-mode .cabin-label.first-class-label {
            background: rgba(245, 158, 11, 0.2);
            color: #92400e;
        }
        
        body.light-mode .cabin-label.economy-label {
            background: rgba(14, 165, 233, 0.2);
            color: #0c4a6e;
        }
        
        body.light-mode .mode-toggle button {
            background: rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }
        
        body.light-mode .mode-toggle button.active {
            background: var(--primary);
            color: white;
        }
        
        /* Enhanced flight tracking styles */
        .flight-tracking-container {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .flight-progress-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        .flight-status-panel {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 6px;
            z-index: 1000;
            min-width: 180px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .status-label {
            color: #ccc;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        .flight-path-animation {
            stroke-dasharray: 10, 5;
            animation: dash 30s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        
        .plane-trail {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .trail-dot {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(14, 165, 233, 0.7);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .cabin-section {
            margin-bottom: 20px;
        }
        
        .cabin-label {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .first-class-label {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .economy-label {
            background: rgba(14, 165, 233, 0.2);
            color: #0ea5e9;
        }
        
        .cabin-divider {
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            margin: 15px 0;
        }
        
        .seat-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .row-number {
            width: 30px;
            text-align: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .seat-group {
            display: flex;
        }
        
        .aisle-space {
            width: 60px;
            text-align: center;
            font-size: 0.7rem;
            color: #9aa4b2;
        }
        
        .city-label-container {
            background: transparent !important;
            border: none !important;
        }
        
        .city-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
        }
        
        body.light-mode .city-label {
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .flight-status-panel,
        body.light-mode .tracking-overlay,
        body.light-mode .flight-progress-indicator {
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .status-label {
            color: #64748b;
        }

        /* NEW: Achievement styles */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            margin: 4px;
        }
        
        .achievement-badge i {
            color: #f59e0b;
        }
        
        /* NEW: Statistics styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
        }
        
        /* NEW: Settings panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: var(--bg);
            z-index: 2000;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            padding: 20px;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        .settings-overlay.active {
            display: block;
        }
        
        /* NEW: Flight history */
        .flight-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* NEW: Fullscreen map styles */
        .fullscreen-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 3000;
            background: #0f172a;
        }
        
        .fullscreen-map #map {
            height: 100vh;
            border-radius: 0;
        }
        
        .fullscreen-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 10px 15px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .fullscreen-boarding-pass {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
        }
        
        .map-type-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .map-type-btn {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-type-btn:hover {
            background: rgba(30, 41, 59, 0.9);
        }
        
        .map-type-btn.active {
            background: var(--primary);
        }
        
        /* NEW: Responsive improvements */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .pass {
                flex-direction: column;
            }
            
            .pass .left, .pass .right {
                width: 100%;
            }
            
            .perforation {
                display: none;
            }
            
            .flight-status-panel {
                position: relative;
                top: auto;
                left: auto;
                margin-top: 10px;
            }
            
            .tracking-overlay {
                flex-direction: column;
                gap: 5px;
            }
            
            .fullscreen-boarding-pass {
                width: 95%;
            }
        }
        
        /* NEW: Airplane icon styles */
        .airplane-icon {
            width: 40px;
            height: 40px;
            background: #2196F3;
            clip-path: polygon(0% 50%, 10% 40%, 20% 30%, 30% 25%, 40% 20%, 60% 20%, 70% 25%, 80% 30%, 90% 40%, 100% 50%, 90% 60%, 80% 70%, 70% 75%, 60% 80%, 40% 80%, 30% 75%, 20% 70%, 10% 60%);
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.7);
            transform: rotate(0deg);
            transition: transform 0.2s ease;
            position: relative;
        }
        
        .airplane-icon:before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFC107;
            border-radius: 50%;
            top: 16px;
            left: 10px;
        }
        
        .airplane-icon:after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFC107;
            border-radius: 50%;
            top: 16px;
            right: 10px;
        }
        
        /* NEW: Airplane icon image */
        .airplane-image {
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="%230ea5e9" d="M482.3 192c34.2 0 93.7 29 93.7 64c0 36-59.5 64-93.7 64H365.7L265.2 495.9c-5.7 10-16.3 16.1-27.8 16.1h-56.2c-10.6 0-18.3-10.2-15.4-20.4l49-171.6H112l-43.2 57.6c-3 4-7.8 6.4-12.8 6.4H14c-7.8 0-14-6.3-14-14c0-1.3 .2-2.6 .5-3.9L32 256 .5 145.9c-.4-1.3-.5-2.6-.5-3.9c0-7.8 6.3-14 14-14h42c5 0 9.8 2.4 12.8 6.4L112 192h102.9l-49-171.6C162.9 10.2 170.6 0 181.2 0h56.2c11.5 0 22.1 6.2 27.8 16.1L365.7 192h116.5z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transform: rotate(0deg);
            transition: transform 0.2s ease;
        }
        
        /* Name Input Modal */
        .name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }
        
        .name-modal.hidden {
            display: none;
        }
        
        .name-modal-content {
            background: var(--bg);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .name-input {
            width: 100%;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
        }
        
        body.light-mode .name-input {
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        
        body.light-mode .name-modal-content {
            background: white;
            color: #1e293b;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Name Input Modal -->
    <div id="name-modal" class="name-modal">
        <div class="name-modal-content">
            <h2 class="text-2xl font-bold text-white mb-4">Welcome to FocusFlight!</h2>
            <p class="text-slate-300 mb-6">Please enter your name to begin your journey</p>
            <input type="text" id="passenger-name" class="name-input" placeholder="Enter your name" maxlength="30">
            <button id="confirm-name" class="w-full py-3 bg-sky-600 text-white rounded-lg font-bold hover:bg-sky-700">
                Start Flying
            </button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden">
        <i class="fas fa-bell"></i>
        <span id="notification-text">Break time! Time to rest.</span>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">Settings</h2>
            <button id="close-settings" class="p-2 rounded-full bg-slate-800 hover:bg-slate-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <div class="glass-card rounded-2xl p-4">
                <h3 class="font-bold text-white mb-3">Sound Settings</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300">Timer Sounds</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="timer-sounds" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
                        </label>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300">Plane Sounds</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="plane-sounds" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-4">
                <h3 class="font-bold text-white mb-3">Flight History</h3>
                <div id="flight-history" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Flight history will be populated here -->
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-4">
                <h3 class="font-bold text-white mb-3">Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-flights">0</div>
                        <div class="stat-label">Total Flights</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-focus-time">0h</div>
                        <div class="stat-label">Focus Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="current-streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-4">
                <h3 class="font-bold text-white mb-3">Data Management</h3>
                <div class="space-y-3">
                    <button id="export-data" class="w-full py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600">
                        <i class="fas fa-download mr-2"></i>Export Data
                    </button>
                    <button id="reset-data" class="w-full py-2 bg-red-700 text-white rounded-lg hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settings-overlay" class="settings-overlay"></div>

    <!-- Fullscreen Map View -->
    <div id="fullscreen-map" class="fullscreen-map hidden-view">
        <div id="map-fullscreen"></div>
        <div class="fullscreen-timer" id="fullscreen-timer">25:00</div>
        <div class="fullscreen-boarding-pass" id="fullscreen-boarding-pass">
            <!-- Boarding pass will be injected here -->
        </div>
        <div class="map-type-controls">
            <button class="map-type-btn active" data-type="satellite">
                <i class="fas fa-satellite"></i> Satellite
            </button>
            <button class="map-type-btn" data-type="street">
                <i class="fas fa-map"></i> Street
            </button>
            <button class="map-type-btn" data-type="terrain">
                <i class="fas fa-mountain"></i> Terrain
            </button>
            <button id="exit-fullscreen-map" class="map-type-btn bg-red-600 hover:bg-red-700">
                <i class="fas fa-times"></i> Exit
            </button>
        </div>
    </div>

    <!-- Navigation Bar -->
    <div class="mode-toggle">
        <button id="lightModeBtn" class="mr-2"><i class="fas fa-sun mr-2"></i>Light</button>
        <button id="darkModeBtn" class="active"><i class="fas fa-moon mr-2"></i>Dark</button>
    </div>

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl mx-auto space-y-6">

            <!-- View 1: Flight Selection -->
            <div id="flight-selection-view" class="glass-card rounded-3xl p-8">
                <div class="text-center mb-8">
                    <div class="flex justify-center items-center gap-3 mb-4">
                         <div class="logo">FO</div>
                        <h1 class="text-4xl font-black bg-gradient-to-r from-sky-400 to-cyan-300 bg-clip-text text-transparent">FocusFlight</h1>
                    </div>
                    <p class="text-slate-300 mt-2 text-lg">Select your flight to begin your focus journey.</p>
                </div>
                
                <!-- Pomodoro Settings -->
                <div class="glass-card rounded-2xl p-6 mb-8">
                    <h3 class="font-bold text-xl text-white mb-4 flex items-center"><i class="fas fa-cog mr-3 text-sky-400"></i>Pomodoro Settings</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button class="pomodoro-btn active py-3 rounded-xl bg-sky-600 text-white flex flex-col items-center" data-focus="25" data-break="5">
                            <span class="font-bold">Classic</span>
                            <span class="text-sm opacity-90">25/5</span>
                        </button>
                        <button class="pomodoro-btn py-3 rounded-xl bg-slate-700 text-slate-200 flex flex-col items-center" data-focus="50" data-break="10">
                            <span class="font-bold">Deep Work</span>
                            <span class="text-sm opacity-90">50/10</span>
                        </button>
                        <button class="pomodoro-btn py-3 rounded-xl bg-slate-700 text-slate-200 flex flex-col items-center" data-focus="90" data-break="30">
                            <span class="font-bold">Extended</span>
                            <span class="text-sm opacity-90">90/30</span>
                        </button>
                        <button class="pomodoro-btn py-3 rounded-xl bg-slate-700 text-slate-200 flex flex-col items-center" data-focus="custom">
                            <span class="font-bold">Custom</span>
                            <span class="text-sm opacity-90"><i class="fas fa-sliders"></i></span>
                        </button>
                    </div>
                    
                    <!-- Custom Settings (Hidden by default) -->
                    <div id="custom-settings" class="mt-6 hidden space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-slate-300 font-medium">Focus Duration (min):</label>
                            <input type="number" id="custom-focus" min="5" max="180" value="25" class="w-24 p-2 bg-slate-800 border border-slate-600 rounded-lg text-white">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-slate-300 font-medium">Break Duration (min):</label>
                            <input type="number" id="custom-break" min="1" max="60" value="5" class="w-24 p-2 bg-slate-800 border border-slate-600 rounded-lg text-white">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-slate-300 font-medium">Long Break (min):</label>
                            <input type="number" id="custom-long-break" min="5" max="90" value="15" class="w-24 p-2 bg-slate-800 border border-slate-600 rounded-lg text-white">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-slate-300 font-medium">Sessions before long break:</label>
                            <input type="number" id="custom-sessions" min="2" max="8" value="4" class="w-24 p-2 bg-slate-800 border border-slate-600 rounded-lg text-white">
                        </div>
                        <button id="apply-custom" class="w-full py-3 bg-sky-600 text-white rounded-lg font-bold hover:bg-sky-700"><i class="fas fa-check mr-2"></i>Apply Custom Settings</button>
                    </div>
                </div>
                
                <h3 class="font-bold text-xl text-white mb-4 flex items-center"><i class="fas fa-plane-departure mr-3 text-sky-400"></i>Available Flights</h3>
                <div id="flight-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Flight cards will be injected here by JS -->
                </div>
            </div>

            <!-- View 2: Seat Selection -->
            <div id="seat-selection-view" class="glass-card rounded-3xl p-8 hidden-view">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Choose Your Seat</h2>
                    <p class="text-slate-300">Select your preferred seat for this flight</p>
                </div>
                
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="md:w-2/3">
                        <div class="bg-slate-800 rounded-2xl p-6 mb-6">
                            <h3 class="font-bold text-white mb-4 text-center">Cabin Layout</h3>
                            <div id="seat-map" class="flex flex-col items-center">
                                <!-- Seat layout will be injected here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:w-1/3">
                        <div class="bg-slate-800 rounded-2xl p-6">
                            <h3 class="font-bold text-white mb-4">Flight Details</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Flight:</span>
                                    <span id="seat-flight-route" class="text-white font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Duration:</span>
                                    <span id="seat-flight-duration" class="text-white font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Selected Seat:</span>
                                    <span id="selected-seat-display" class="text-sky-400 font-bold">None</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Class:</span>
                                    <span id="selected-class-display" class="text-amber-400 font-bold">-</span>
                                </div>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t border-slate-700">
                                <h4 class="font-bold text-white mb-2">Seat Legend</h4>
                                <div class="flex items-center mb-2">
                                    <div class="seat mr-3 bg-sky-600"></div>
                                    <span class="text-slate-300">Selected (Economy)</span>
                                </div>
                                <div class="flex items-center mb-2">
                                    <div class="seat mr-3 first-class"></div>
                                    <span class="text-slate-300">Selected (First Class)</span>
                                </div>
                                <div class="flex items-center mb-2">
                                    <div class="seat mr-3 bg-slate-700"></div>
                                    <span class="text-slate-300">Available</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="seat mr-3 bg-red-900 occupied"></div>
                                    <span class="text-slate-300">Occupied</span>
                                </div>
                            </div>
                            
                            <button id="confirm-seat-btn" class="w-full mt-6 py-3 bg-sky-600 text-white rounded-lg font-bold hover:bg-sky-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-check mr-2"></i>Confirm Seat & Continue
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View 3: Boarding Pass -->
            <div id="boarding-pass-view" class="glass-card rounded-3xl p-8 hidden-view">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Your Boarding Pass</h2>
                    <p class="text-slate-300">Ready for departure</p>
                </div>
                
                <div id="boarding-pass" class="pass first">
                    <div class="left">
                        <div>
                            <div class="brand">
                                <div class="logo">FO</div>
                                <div>
                                    <h3>Focus Airlines â€” First</h3>
                                    <p>Concierge boarding Â· Lounge access Â· Extra baggage</p>
                                </div>
                                <div style="margin-left:auto; text-align:right">
                                    <div class="tag" id="bp-class-tag">FIRST â€¢ LOUNGE</div>
                                    <div style="font-size:12px; color:var(--muted); margin-top:6px" id="bp-ref">REF: FOC-9K2</div>
                                </div>
                            </div>

                            <div style="margin-top:18px; display:flex; justify-content:space-between; align-items:center">
                                <div>
                                    <div class="route">
                                        <div>
                                            <div class="code" id="bp-route">JNB â†’ LHR</div>
                                            <div class="city" id="bp-cities">Johannesburg â€” London</div>
                                        </div>
                                    </div>
                                    <div class="meta">
                                        <div class="item"><div class="label">Passenger</div><div class="value" id="bp-passenger">Focus Traveler</div></div>
                                        <div class="item"><div class="label">Seat</div><div class="value" id="bp-seat">1A</div></div>
                                        <div class="item"><div class="label">Gate</div><div class="value" id="bp-gate">A12</div></div>
                                        <div class="item"><div class="label">Boarding</div><div class="value" id="bp-boarding">08:20 â€¢ 2025-10-12</div></div>
                                    </div>
                                </div>

                                <div style="text-align:right">
                                    <div style="font-size:12px; color:var(--muted)">Class</div>
                                    <div style="font-size:22px; font-weight:900; color:var(--gold)" id="bp-class-display">FIRST</div>
                                    <div style="margin-top:8px; font-weight:700" id="bp-priority">Priority</div>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px">
                            <div class="footer-note" id="bp-benefits">Includes chauffeur transfer & priority check-in</div>
                            <div class="footer-note muted" id="bp-ticket-code">Ticket code: 001-FOC-1</div>
                        </div>
                    </div>

                    <div class="right">
                        <div style="align-self:stretch; display:flex; flex-direction:column; justify-content:space-between; gap:12px; align-items:flex-end;">
                            <div style="width:100%; display:flex; justify-content:flex-end">
                                <div class="qr" aria-hidden="true">QR</div>
                            </div>

                            <div style="width:100%; display:flex; justify-content:flex-end; gap:10px;">
                                <div style="text-align:right">
                                    <div class="label muted">Pax type</div>
                                    <div class="value">ADULT</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="perforation" aria-hidden="true"></div>
                </div>
                
                <div class="flex justify-center mt-8">
                    <button id="start-flight-btn" class="py-3 px-8 bg-sky-600 text-white rounded-lg font-bold hover:bg-sky-700 flex items-center">
                        <i class="fas fa-plane-departure mr-2"></i> Begin Flight
                    </button>
                </div>
            </div>

            <!-- View 4: Timer & Map View -->
            <div id="timer-view" class="glass-card rounded-3xl p-8 hidden-view">
                <div class="space-y-6">
                    <!-- Flight Info Header -->
                    <div class="text-center border-b border-slate-700 pb-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="fullscreen-map-btn" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700">
                                <i class="fas fa-expand text-slate-300"></i>
                            </button>
                            <div>
                                <p class="text-slate-400 font-medium">In-flight to:</p>
                                <h2 id="flight-destination" class="text-2xl font-bold text-white"></h2>
                            </div>
                            <button id="settings-btn" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700">
                                <i class="fas fa-cog text-slate-300"></i>
                            </button>
                        </div>
                        <div class="flex justify-center items-center mt-2 text-sm text-slate-400">
                            <span id="flight-origin-code" class="font-medium text-white"></span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            <span id="flight-dest-code" class="font-medium text-white"></span>
                        </div>
                        <div class="mt-2 text-sm text-slate-400">
                            <span id="flight-duration"></span> â€¢ <span id="pomodoro-settings-display"></span> â€¢ <span id="seat-display" class="text-sky-400 font-bold"></span> â€¢ <span id="class-display" class="text-amber-400 font-bold"></span>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="map-container" class="bg-slate-800 rounded-2xl p-4 relative overflow-hidden">
                        <!-- Flight Tracking Overlay -->
                        <div class="tracking-overlay">
                            <div class="overlay-item">
                                <span>Tracking:</span>
                                <div class="tracking-indicator" id="tracking-indicator"></div>
                                <span id="tracking-status">ON</span>
                            </div>
                            <div class="overlay-item">
                                <span>Zoom:</span>
                                <span id="zoom-level">5</span>
                            </div>
                        </div>
                        
                        <div id="map"></div>
                        
                        <!-- Flight Status Panel -->
                        <div class="flight-status-panel">
                            <div class="status-item">
                                <span class="status-label">Speed:</span>
                                <span class="status-value" id="flight-speed">850 km/h</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Altitude:</span>
                                <span class="status-value" id="flight-altitude">35,000 ft</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">ETA:</span>
                                <span class="status-value" id="flight-eta">Calculating...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Distance:</span>
                                <span class="status-value" id="map-distance">Calculating...</span>
                            </div>
                        </div>
                        
                        <!-- Map Overlays -->
                        <div class="map-overlay">
                            <div class="text-sm font-medium text-white">Flight Path</div>
                            <div class="text-xs text-slate-400" id="map-progress">Progress: 0%</div>
                        </div>
                        
                        <div class="map-legend">
                            <div class="legend-item">
                                <div class="legend-color bg-sky-500"></div>
                                <span>Flight Path</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-green-500"></div>
                                <span>Origin</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-red-500"></div>
                                <span>Destination</span>
                            </div>
                        </div>
                        
                        <div class="map-controls">
                            <button id="zoom-in-btn" title="Zoom In">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button id="zoom-out-btn" title="Zoom Out">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button id="reset-view-btn" title="Reset View">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button id="toggle-map-btn" title="Toggle Map Style">
                                <i class="fas fa-layer-group"></i>
                            </button>
                            <button id="toggle-terrain-btn" title="Toggle Terrain">
                                <i class="fas fa-mountain"></i>
                            </button>
                        </div>
                        
                        <!-- Weather and time overlays -->
                        <div class="weather-overlay" id="weather-overlay"></div>
                        <div class="time-of-day" id="time-of-day"></div>
                        
                        <!-- Plane trail -->
                        <div class="plane-trail" id="plane-trail"></div>
                    </div>
                     
                    <!-- Flight Progress -->
                    <div class="space-y-2">
                        <div class="flex justify-between font-semibold text-sm text-slate-400">
                           <span id="flight-origin-code-progress"></span>
                           <span id="flight-progress-text">0%</span>
                           <span id="flight-dest-code-progress"></span>
                        </div>
                        <div class="w-full bg-slate-800 rounded-full h-3">
                          <div id="flight-progress-bar" class="bg-gradient-to-r from-sky-500 to-cyan-400 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Mode Selector -->
                    <div class="bg-slate-800 rounded-full p-1.5 flex justify-between items-center text-slate-300 font-medium">
                        <button id="focusBtn" class="mode-btn active w-1/3 py-3 rounded-full flex items-center justify-center">
                            <i class="fas fa-brain mr-2"></i> Focus
                        </button>
                        <button id="shortBreakBtn" class="mode-btn w-1/3 py-3 rounded-full flex items-center justify-center">
                            <i class="fas fa-coffee mr-2"></i> Short Break
                        </button>
                        <button id="longBreakBtn" class="mode-btn w-1/3 py-3 rounded-full flex items-center justify-center">
                            <i class="fas fa-couch mr-2"></i> Long Break
                        </button>
                    </div>

                    <!-- Timer Display -->
                    <div class="flex justify-center items-center my-4 relative">
                        <svg class="progress-ring w-64 h-64" width="256" height="256">
                            <circle class="progress-ring-circle" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="transparent" r="112" cx="128" cy="128"/>
                            <circle id="progress-circle" class="progress-ring-circle" stroke="url(#gradient)" stroke-width="8" stroke-linecap="round" fill="transparent" r="112" cx="128" cy="128" stroke-dasharray="703" stroke-dashoffset="703"/>
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#0ea5e9" />
                                    <stop offset="100%" stop-color="#22d3ee" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <p id="timer-display" class="text-7xl font-black text-white absolute">25:00</p>
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-6">
                         <button id="reset-btn" class="w-16 h-16 flex items-center justify-center bg-slate-800 text-slate-300 rounded-full hover:bg-slate-700">
                            <i class="fas fa-redo text-xl"></i>
                        </button>
                        <button id="start-pause-btn" class="w-24 h-24 flex items-center justify-center bg-gradient-to-r from-sky-500 to-cyan-400 text-white rounded-full shadow-lg shadow-sky-500/30 hover:shadow-sky-500/50">
                            <i id="play-icon" class="fas fa-play text-3xl ml-1"></i>
                            <i id="pause-icon" class="fas fa-pause text-3xl hidden"></i>
                        </button>
                        <button id="end-flight-btn" title="End Flight" class="w-16 h-16 flex items-center justify-center bg-slate-800 text-slate-300 rounded-full hover:bg-red-900 hover:text-red-200">
                            <i class="fas fa-power-off text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Session Stats -->
                    <div class="bg-slate-800 rounded-2xl p-6 mt-6">
                        <h3 class="font-bold text-white mb-4 text-center">Flight Statistics</h3>
                        <div class="flex justify-between text-sm text-slate-300">
                            <div class="text-center">
                                <p class="font-bold text-white text-2xl" id="completed-sessions">0</p>
                                <p class="text-slate-400">Sessions</p>
                            </div>
                            <div class="text-center">
                                <p class="font-bold text-white text-2xl" id="flight-progress-minutes">0</p>
                                <p class="text-slate-400">Minutes</p>
                            </div>
                            <div class="text-center">
                                <p class="font-bold text-white text-2xl" id="flight-progress-percent">0%</p>
                                <p class="text-slate-400">Complete</p>
                            </div>
                            <div class="text-center">
                                <p class="font-bold text-white text-2xl" id="flight-remaining">0h 0m</p>
                                <p class="text-slate-400">Remaining</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<script>
    // --- DATA & CONFIG ---
    const FLIGHTS = [
        // Original 6 flights
        { id: 'cpt-jnb', origin: 'Cape Town (CPT)', destination: 'Johannesburg (JNB)', duration: 120, coords: { from: [-33.96, 18.60], to: [-26.13, 28.24] } },
        { id: 'jnb-dbn', origin: 'Johannesburg (JNB)', destination: 'Durban (DBN)', duration: 70, coords: { from: [-26.13, 28.24], to: [-29.97, 30.95] } },
        { id: 'jnb-lhr', origin: 'Johannesburg (JNB)', destination: 'London (LHR)', duration: 690, coords: { from: [-26.13, 28.24], to: [51.47, -0.45] } },
        { id: 'jnb-jfk', origin: 'Johannesburg (JNB)', destination: 'New York (JFK)', duration: 930, coords: { from: [-26.13, 28.24], to: [40.64, -73.77] } },
        { id: 'nyc-tok', origin: 'New York (JFK)', destination: 'Tokyo (HND)', duration: 840, coords: { from: [40.64, -73.77], to: [35.55, 139.78] } },
        { id: 'syd-dxb', origin: 'Sydney (SYD)', destination: 'Dubai (DXB)', duration: 840, coords: { from: [-33.95, 151.18], to: [25.25, 55.36] } },
        
        // 63 additional flights (total 69)
        { id: 'lhr-cdg', origin: 'London (LHR)', destination: 'Paris (CDG)', duration: 75, coords: { from: [51.47, -0.45], to: [49.01, 2.55] } },
        { id: 'cdg-fra', origin: 'Paris (CDG)', destination: 'Frankfurt (FRA)', duration: 80, coords: { from: [49.01, 2.55], to: [50.03, 8.53] } },
        { id: 'fra-ams', origin: 'Frankfurt (FRA)', destination: 'Amsterdam (AMS)', duration: 70, coords: { from: [50.03, 8.53], to: [52.31, 4.76] } },
        { id: 'ams-mad', origin: 'Amsterdam (AMS)', destination: 'Madrid (MAD)', duration: 145, coords: { from: [52.31, 4.76], to: [40.49, -3.57] } },
        { id: 'mad-lis', origin: 'Madrid (MAD)', destination: 'Lisbon (LIS)', duration: 90, coords: { from: [40.49, -3.57], to: [38.77, -9.14] } },
        { id: 'lis-opo', origin: 'Lisbon (LIS)', destination: 'Porto (OPO)', duration: 60, coords: { from: [38.77, -9.14], to: [41.25, -8.68] } },
        { id: 'opo-bcn', origin: 'Porto (OPO)', destination: 'Barcelona (BCN)', duration: 105, coords: { from: [41.25, -8.68], to: [41.30, 2.08] } },
        { id: 'bcn-rom', origin: 'Barcelona (BCN)', destination: 'Rome (FCO)', duration: 110, coords: { from: [41.30, 2.08], to: [41.80, 12.25] } },
        { id: 'rom-ath', origin: 'Rome (FCO)', destination: 'Athens (ATH)', duration: 105, coords: { from: [41.80, 12.25], to: [37.94, 23.94] } },
        { id: 'ath-ist', origin: 'Athens (ATH)', destination: 'Istanbul (IST)', duration: 75, coords: { from: [37.94, 23.94], to: [41.27, 28.75] } },
        { id: 'ist-dxb', origin: 'Istanbul (IST)', destination: 'Dubai (DXB)', duration: 270, coords: { from: [41.27, 28.75], to: [25.25, 55.36] } },
        { id: 'dxb-bkk', origin: 'Dubai (DXB)', destination: 'Bangkok (BKK)', duration: 360, coords: { from: [25.25, 55.36], to: [13.68, 100.75] } },
        { id: 'bkk-sin', origin: 'Bangkok (BKK)', destination: 'Singapore (SIN)', duration: 135, coords: { from: [13.68, 100.75], to: [1.36, 103.99] } },
        { id: 'sin-kul', origin: 'Singapore (SIN)', destination: 'Kuala Lumpur (KUL)', duration: 60, coords: { from: [1.36, 103.99], to: [2.75, 101.71] } },
        { id: 'kul-cgk', origin: 'Kuala Lumpur (KUL)', destination: 'Jakarta (CGK)', duration: 105, coords: { from: [2.75, 101.71], to: [-6.13, 106.66] } },
        { id: 'cgk-mnl', origin: 'Jakarta (CGK)', destination: 'Manila (MNL)', duration: 240, coords: { from: [-6.13, 106.66], to: [14.51, 121.02] } },
        { id: 'mnl-tpe', origin: 'Manila (MNL)', destination: 'Taipei (TPE)', duration: 135, coords: { from: [14.51, 121.02], to: [25.08, 121.23] } },
        { id: 'tpe-hkg', origin: 'Taipei (TPE)', destination: 'Hong Kong (HKG)', duration: 105, coords: { from: [25.08, 121.23], to: [22.31, 113.92] } },
        { id: 'hkg-pvg', origin: 'Hong Kong (HKG)', destination: 'Shanghai (PVG)', duration: 150, coords: { from: [22.31, 113.92], to: [31.14, 121.81] } },
        { id: 'pvg-pek', origin: 'Shanghai (PVG)', destination: 'Beijing (PEK)', duration: 135, coords: { from: [31.14, 121.81], to: [40.08, 116.58] } },
        { id: 'pek-icn', origin: 'Beijing (PEK)', destination: 'Seoul (ICN)', duration: 120, coords: { from: [40.08, 116.58], to: [37.46, 126.44] } },
        { id: 'icn-nrt', origin: 'Seoul (ICN)', destination: 'Tokyo (NRT)', duration: 135, coords: { from: [37.46, 126.44], to: [35.76, 140.39] } },
        { id: 'nrt-hnd', origin: 'Tokyo (NRT)', destination: 'Tokyo (HND)', duration: 30, coords: { from: [35.76, 140.39], to: [35.55, 139.78] } },
        { id: 'hnd-cts', origin: 'Tokyo (HND)', destination: 'Sapporo (CTS)', duration: 90, coords: { from: [35.55, 139.78], to: [42.78, 141.68] } },
        { id: 'cts-kix', origin: 'Sapporo (CTS)', destination: 'Osaka (KIX)', duration: 105, coords: { from: [42.78, 141.68], to: [34.43, 135.24] } },
        { id: 'kix-fuk', origin: 'Osaka (KIX)', destination: 'Fukuoka (FUK)', duration: 75, coords: { from: [34.43, 135.24], to: [33.59, 130.45] } },
        { id: 'fuk-oka', origin: 'Fukuoka (FUK)', destination: 'Okinawa (OKA)', duration: 105, coords: { from: [33.59, 130.45], to: [26.20, 127.65] } },
        { id: 'oka-tpe', origin: 'Okinawa (OKA)', destination: 'Taipei (TPE)', duration: 75, coords: { from: [26.20, 127.65], to: [25.08, 121.23] } },
        { id: 'tpe-bki', origin: 'Taipei (TPE)', destination: 'Kota Kinabalu (BKI)', duration: 180, coords: { from: [25.08, 121.23], to: [5.94, 116.05] } },
        { id: 'bki-dps', origin: 'Kota Kinabalu (BKI)', destination: 'Bali (DPS)', duration: 150, coords: { from: [5.94, 116.05], to: [-8.75, 115.17] } },
        { id: 'dps-per', origin: 'Bali (DPS)', destination: 'Perth (PER)', duration: 240, coords: { from: [-8.75, 115.17], to: [-31.94, 115.97] } },
        { id: 'per-adl', origin: 'Perth (PER)', destination: 'Adelaide (ADL)', duration: 180, coords: { from: [-31.94, 115.97], to: [-34.95, 138.53] } },
        { id: 'adl-mel', origin: 'Adelaide (ADL)', destination: 'Melbourne (MEL)', duration: 60, coords: { from: [-34.95, 138.53], to: [-37.67, 144.84] } },
        { id: 'mel-syd', origin: 'Melbourne (MEL)', destination: 'Sydney (SYD)', duration: 75, coords: { from: [-37.67, 144.84], to: [-33.95, 151.18] } },
        { id: 'syd-bne', origin: 'Sydney (SYD)', destination: 'Brisbane (BNE)', duration: 90, coords: { from: [-33.95, 151.18], to: [-27.38, 153.12] } },
        { id: 'bne-cns', origin: 'Brisbane (BNE)', destination: 'Cairns (CNS)', duration: 135, coords: { from: [-27.38, 153.12], to: [-16.88, 145.75] } },
        { id: 'cns-drw', origin: 'Cairns (CNS)', destination: 'Darwin (DRW)', duration: 150, coords: { from: [-16.88, 145.75], to: [-12.41, 130.88] } },
        { id: 'drw-dps', origin: 'Darwin (DRW)', destination: 'Bali (DPS)', duration: 135, coords: { from: [-12.41, 130.88], to: [-8.75, 115.17] } },
        { id: 'dps-sin', origin: 'Bali (DPS)', destination: 'Singapore (SIN)', duration: 150, coords: { from: [-8.75, 115.17], to: [1.36, 103.99] } },
        { id: 'sin-bom', origin: 'Singapore (SIN)', destination: 'Mumbai (BOM)', duration: 300, coords: { from: [1.36, 103.99], to: [19.09, 72.87] } },
        { id: 'bom-del', origin: 'Mumbai (BOM)', destination: 'Delhi (DEL)', duration: 120, coords: { from: [19.09, 72.87], to: [28.56, 77.10] } },
        { id: 'del-ccu', origin: 'Delhi (DEL)', destination: 'Kolkata (CCU)', duration: 120, coords: { from: [28.56, 77.10], to: [22.65, 88.45] } },
        { id: 'ccu-dac', origin: 'Kolkata (CCU)', destination: 'Dhaka (DAC)', duration: 60, coords: { from: [22.65, 88.45], to: [23.84, 90.41] } },
        { id: 'dac-rgn', origin: 'Dhaka (DAC)', destination: 'Yangon (RGN)', duration: 75, coords: { from: [23.84, 90.41], to: [16.91, 96.13] } },
        { id: 'rgn-bkk', origin: 'Yangon (RGN)', destination: 'Bangkok (BKK)', duration: 60, coords: { from: [16.91, 96.13], to: [13.68, 100.75] } },
        { id: 'bkk-hkt', origin: 'Bangkok (BKK)', destination: 'Phuket (HKT)', duration: 75, coords: { from: [13.68, 100.75], to: [8.11, 98.31] } },
        { id: 'hkt-kul', origin: 'Phuket (HKT)', destination: 'Kuala Lumpur (KUL)', duration: 90, coords: { from: [8.11, 98.31], to: [2.75, 101.71] } },
        { id: 'kul-sgn', origin: 'Kuala Lumpur (KUL)', destination: 'Ho Chi Minh (SGN)', duration: 75, coords: { from: [2.75, 101.71], to: [10.82, 106.66] } },
        { id: 'sgn-han', origin: 'Ho Chi Minh (SGN)', destination: 'Hanoi (HAN)', duration: 105, coords: { from: [10.82, 106.66], to: [21.22, 105.81] } },
        { id: 'han-hkg', origin: 'Hanoi (HAN)', destination: 'Hong Kong (HKG)', duration: 120, coords: { from: [21.22, 105.81], to: [22.31, 113.92] } },
        { id: 'hkg-mnl', origin: 'Hong Kong (HKG)', destination: 'Manila (MNL)', duration: 120, coords: { from: [22.31, 113.92], to: [14.51, 121.02] } },
        { id: 'mnl-ceb', origin: 'Manila (MNL)', destination: 'Cebu (CEB)', duration: 75, coords: { from: [14.51, 121.02], to: [10.31, 123.98] } },
        { id: 'ceb-dvo', origin: 'Cebu (CEB)', destination: 'Davao (DVO)', duration: 90, coords: { from: [10.31, 123.98], to: [7.13, 125.65] } },
        { id: 'dvo-bki', origin: 'Davao (DVO)', destination: 'Kota Kinabalu (BKI)', duration: 105, coords: { from: [7.13, 125.65], to: [5.94, 116.05] } },
        { id: 'bki-sin', origin: 'Kota Kinabalu (BKI)', destination: 'Singapore (SIN)', duration: 120, coords: { from: [5.94, 116.05], to: [1.36, 103.99] } },
        { id: 'sin-cgk', origin: 'Singapore (SIN)', destination: 'Jakarta (CGK)', duration: 90, coords: { from: [1.36, 103.99], to: [-6.13, 106.66] } },
        { id: 'cgk-dps', origin: 'Jakarta (CGK)', destination: 'Bali (DPS)', duration: 105, coords: { from: [-6.13, 106.66], to: [-8.75, 115.17] } },
        { id: 'dps-per', origin: 'Bali (DPS)', destination: 'Perth (PER)', duration: 240, coords: { from: [-8.75, 115.17], to: [-31.94, 115.97] } },
        { id: 'per-adl', origin: 'Perth (PER)', destination: 'Adelaide (ADL)', duration: 180, coords: { from: [-31.94, 115.97], to: [-34.95, 138.53] } },
        { id: 'adl-syd', origin: 'Adelaide (ADL)', destination: 'Sydney (SYD)', duration: 105, coords: { from: [-34.95, 138.53], to: [-33.95, 151.18] } },
        { id: 'syd-akl', origin: 'Sydney (SYD)', destination: 'Auckland (AKL)', duration: 180, coords: { from: [-33.95, 151.18], to: [-37.01, 174.79] } },
        { id: 'akl-wlg', origin: 'Auckland (AKL)', destination: 'Wellington (WLG)', duration: 60, coords: { from: [-37.01, 174.79], to: [-41.29, 174.78] } },
        { id: 'wlg-chc', origin: 'Wellington (WLG)', destination: 'Christchurch (CHC)', duration: 60, coords: { from: [-41.29, 174.78], to: [-43.49, 172.53] } },
        { id: 'chc-zqn', origin: 'Christchurch (CHC)', destination: 'Queenstown (ZQN)', duration: 60, coords: { from: [-43.49, 172.53], to: [-45.02, 168.74] } },
        { id: 'zqn-akl', origin: 'Queenstown (ZQN)', destination: 'Auckland (AKL)', duration: 120, coords: { from: [-45.02, 168.74], to: [-37.01, 174.79] } },
        { id: 'akl-syd', origin: 'Auckland (AKL)', destination: 'Sydney (SYD)', duration: 180, coords: { from: [-37.01, 174.79], to: [-33.95, 151.18] } },
        { id: 'syd-mel', origin: 'Sydney (SYD)', destination: 'Melbourne (MEL)', duration: 75, coords: { from: [-33.95, 151.18], to: [-37.67, 144.84] } },
        { id: 'mel-bne', origin: 'Melbourne (MEL)', destination: 'Brisbane (BNE)', duration: 120, coords: { from: [-37.67, 144.84], to: [-27.38, 153.12] } },
        { id: 'bne-cns', origin: 'Brisbane (BNE)', destination: 'Cairns (CNS)', duration: 135, coords: { from: [-27.38, 153.12], to: [-16.88, 145.75] } },
        { id: 'cns-tsv', origin: 'Cairns (CNS)', destination: 'Townsville (TSV)', duration: 60, coords: { from: [-16.88, 145.75], to: [-19.25, 146.77] } },
        { id: 'tsv-bne', origin: 'Townsville (TSV)', destination: 'Brisbane (BNE)', duration: 120, coords: { from: [-19.25, 146.77], to: [-27.38, 153.12] } },
        { id: 'bne-syd', origin: 'Brisbane (BNE)', destination: 'Sydney (SYD)', duration: 90, coords: { from: [-27.38, 153.12], to: [-33.95, 151.18] } },
        { id: 'syd-per', origin: 'Sydney (SYD)', destination: 'Perth (PER)', duration: 285, coords: { from: [-33.95, 151.18], to: [-31.94, 115.97] } },
        { id: 'per-dps', origin: 'Perth (PER)', destination: 'Bali (DPS)', duration: 240, coords: { from: [-31.94, 115.97], to: [-8.75, 115.17] } },
        { id: 'dps-sin', origin: 'Bali (DPS)', destination: 'Singapore (SIN)', duration: 150, coords: { from: [-8.75, 115.17], to: [1.36, 103.99] } },
        { id: 'sin-bkk', origin: 'Singapore (SIN)', destination: 'Bangkok (BKK)', duration: 135, coords: { from: [1.36, 103.99], to: [13.68, 100.75] } },
        { id: 'bkk-hkg', origin: 'Bangkok (BKK)', destination: 'Hong Kong (HKG)', duration: 150, coords: { from: [13.68, 100.75], to: [22.31, 113.92] } },
        { id: 'hkg-tpe', origin: 'Hong Kong (HKG)', destination: 'Taipei (TPE)', duration: 105, coords: { from: [22.31, 113.92], to: [25.08, 121.23] } },
        { id: 'tpe-kix', origin: 'Taipei (TPE)', destination: 'Osaka (KIX)', duration: 150, coords: { from: [25.08, 121.23], to: [34.43, 135.24] } },
        { id: 'kix-icn', origin: 'Osaka (KIX)', destination: 'Seoul (ICN)', duration: 120, coords: { from: [34.43, 135.24], to: [37.46, 126.44] } },
        { id: 'icn-pek', origin: 'Seoul (ICN)', destination: 'Beijing (PEK)', duration: 120, coords: { from: [37.46, 126.44], to: [40.08, 116.58] } },
        { id: 'pek-pvg', origin: 'Beijing (PEK)', destination: 'Shanghai (PVG)', duration: 135, coords: { from: [40.08, 116.58], to: [31.14, 121.81] } },
        { id: 'pvg-hkg', origin: 'Shanghai (PVG)', destination: 'Hong Kong (HKG)', duration: 150, coords: { from: [31.14, 121.81], to: [22.31, 113.92] } },
        { id: 'hkg-sin', origin: 'Hong Kong (HKG)', destination: 'Singapore (SIN)', duration: 195, coords: { from: [22.31, 113.92], to: [1.36, 103.99] } },
        { id: 'sin-kul', origin: 'Singapore (SIN)', destination: 'Kuala Lumpur (KUL)', duration: 60, coords: { from: [1.36, 103.99], to: [2.75, 101.71] } },
        { id: 'kul-bkk', origin: 'Kuala Lumpur (KUL)', destination: 'Bangkok (BKK)', duration: 120, coords: { from: [2.75, 101.71], to: [13.68, 100.75] } },
        { id: 'bkk-del', origin: 'Bangkok (BKK)', destination: 'Delhi (DEL)', duration: 240, coords: { from: [13.68, 100.75], to: [28.56, 77.10] } },
        { id: 'del-bom', origin: 'Delhi (DEL)', destination: 'Mumbai (BOM)', duration: 120, coords: { from: [28.56, 77.10], to: [19.09, 72.87] } },
        { id: 'bom-dxb', origin: 'Mumbai (BOM)', destination: 'Dubai (DXB)', duration: 180, coords: { from: [19.09, 72.87], to: [25.25, 55.36] } },
        { id: 'dxb-ist', origin: 'Dubai (DXB)', destination: 'Istanbul (IST)', duration: 270, coords: { from: [25.25, 55.36], to: [41.27, 28.75] } },
        { id: 'ist-ath', origin: 'Istanbul (IST)', destination: 'Athens (ATH)', duration: 75, coords: { from: [41.27, 28.75], to: [37.94, 23.94] } },
        { id: 'ath-rom', origin: 'Athens (ATH)', destination: 'Rome (FCO)', duration: 105, coords: { from: [37.94, 23.94], to: [41.80, 12.25] } },
        { id: 'rom-bcn', origin: 'Rome (FCO)', destination: 'Barcelona (BCN)', duration: 110, coords: { from: [41.80, 12.25], to: [41.30, 2.08] } },
        { id: 'bcn-lis', origin: 'Barcelona (BCN)', destination: 'Lisbon (LIS)', duration: 105, coords: { from: [41.30, 2.08], to: [38.77, -9.14] } },
        { id: 'lis-mad', origin: 'Lisbon (LIS)', destination: 'Madrid (MAD)', duration: 90, coords: { from: [38.77, -9.14], to: [40.49, -3.57] } },
        { id: 'mad-cdg', origin: 'Madrid (MAD)', destination: 'Paris (CDG)', duration: 120, coords: { from: [40.49, -3.57], to: [49.01, 2.55] } },
        { id: 'cdg-lhr', origin: 'Paris (CDG)', destination: 'London (LHR)', duration: 75, coords: { from: [49.01, 2.55], to: [51.47, -0.45] } },
        { id: 'lhr-jfk', origin: 'London (LHR)', destination: 'New York (JFK)', duration: 480, coords: { from: [51.47, -0.45], to: [40.64, -73.77] } },
        { id: 'jfk-lax', origin: 'New York (JFK)', destination: 'Los Angeles (LAX)', duration: 360, coords: { from: [40.64, -73.77], to: [33.94, -118.41] } },
        { id: 'lax-sfo', origin: 'Los Angeles (LAX)', destination: 'San Francisco (SFO)', duration: 90, coords: { from: [33.94, -118.41], to: [37.62, -122.38] } },
        { id: 'sfo-sea', origin: 'San Francisco (SFO)', destination: 'Seattle (SEA)', duration: 120, coords: { from: [37.62, -122.38], to: [47.45, -122.31] } },
        { id: 'sea-yvr', origin: 'Seattle (SEA)', destination: 'Vancouver (YVR)', duration: 60, coords: { from: [47.45, -122.31], to: [49.19, -123.18] } },
        { id: 'yvr-yyz', origin: 'Vancouver (YVR)', destination: 'Toronto (YYZ)', duration: 270, coords: { from: [49.19, -123.18], to: [43.68, -79.63] } },
        { id: 'yyz-ord', origin: 'Toronto (YYZ)', destination: 'Chicago (ORD)', duration: 90, coords: { from: [43.68, -79.63], to: [41.98, -87.90] } },
        { id: 'ord-atl', origin: 'Chicago (ORD)', destination: 'Atlanta (ATL)', duration: 105, coords: { from: [41.98, -87.90], to: [33.64, -84.43] } },
        { id: 'atl-mia', origin: 'Atlanta (ATL)', destination: 'Miami (MIA)', duration: 105, coords: { from: [33.64, -84.43], to: [25.79, -80.29] } },
        { id: 'mia-mex', origin: 'Miami (MIA)', destination: 'Mexico City (MEX)', duration: 180, coords: { from: [25.79, -80.29], to: [19.44, -99.07] } },
        { id: 'mex-bog', origin: 'Mexico City (MEX)', destination: 'Bogota (BOG)', duration: 240, coords: { from: [19.44, -99.07], to: [4.70, -74.14] } },
        { id: 'bog-lim', origin: 'Bogota (BOG)', destination: 'Lima (LIM)', duration: 180, coords: { from: [4.70, -74.14], to: [-12.02, -77.11] } },
        { id: 'lim-scl', origin: 'Lima (LIM)', destination: 'Santiago (SCL)', duration: 180, coords: { from: [-12.02, -77.11], to: [-33.39, -70.79] } },
        { id: 'scl-eze', origin: 'Santiago (SCL)', destination: 'Buenos Aires (EZE)', duration: 120, coords: { from: [-33.39, -70.79], to: [-34.82, -58.54] } },
        { id: 'eze-gru', origin: 'Buenos Aires (EZE)', destination: 'SÃ£o Paulo (GRU)', duration: 150, coords: { from: [-34.82, -58.54], to: [-23.43, -46.47] } },
        { id: 'gru-gig', origin: 'SÃ£o Paulo (GRU)', destination: 'Rio de Janeiro (GIG)', duration: 60, coords: { from: [-23.43, -46.47], to: [-22.81, -43.25] } },
        { id: 'gig-mia', origin: 'Rio de Janeiro (GIG)', destination: 'Miami (MIA)', duration: 480, coords: { from: [-22.81, -43.25], to: [25.79, -80.29] } },
        { id: 'mia-jfk', origin: 'Miami (MIA)', destination: 'New York (JFK)', duration: 150, coords: { from: [25.79, -80.29], to: [40.64, -73.77] } },
        { id: 'jfk-lhr', origin: 'New York (JFK)', destination: 'London (LHR)', duration: 420, coords: { from: [40.64, -73.77], to: [51.47, -0.45] } },
        { id: 'lhr-cpt', origin: 'London (LHR)', destination: 'Cape Town (CPT)', duration: 660, coords: { from: [51.47, -0.45], to: [-33.96, 18.60] } },
    ];
    
    // Default Pomodoro settings
    let POMODORO_SETTINGS = {
        focus: 25 * 60,
        shortBreak: 5 * 60,
        longBreak: 15 * 60,
        sessionsBeforeLongBreak: 4
    };

    // --- USER DATA ---
    let flightHistory = [];
    let userStats = {
        totalFlights: 0,
        totalFocusTime: 0,
        currentStreak: 0,
        lastFlightDate: null
    };
    let passengerName = "Focus Traveler";

    // --- DOM ELEMENTS ---
    const timerDisplay = document.getElementById('timer-display');
    const startPauseBtn = document.getElementById('start-pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const endFlightBtn = document.getElementById('end-flight-btn');
    const flightSelectionView = document.getElementById('flight-selection-view');
    const seatSelectionView = document.getElementById('seat-selection-view');
    const boardingPassView = document.getElementById('boarding-pass-view');
    const timerView = document.getElementById('timer-view');
    const flightList = document.getElementById('flight-list');
    const pomodoroSettingsDisplay = document.getElementById('pomodoro-settings-display');
    const fullscreenMapBtn = document.getElementById('fullscreen-map-btn');
    const progressCircle = document.getElementById('progress-circle');
    const lightModeBtn = document.getElementById('lightModeBtn');
    const darkModeBtn = document.getElementById('darkModeBtn');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    const startFlightBtn = document.getElementById('start-flight-btn');
    const boardingPass = document.getElementById('boarding-pass');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsOverlay = document.getElementById('settings-overlay');
    const closeSettings = document.getElementById('close-settings');
    const fullscreenMap = document.getElementById('fullscreen-map');
    const mapFullscreen = document.getElementById('map-fullscreen');
    const fullscreenTimer = document.getElementById('fullscreen-timer');
    const fullscreenBoardingPass = document.getElementById('fullscreen-boarding-pass');
    const exitFullscreenMap = document.getElementById('exit-fullscreen-map');
    const mapTypeButtons = document.querySelectorAll('.map-type-btn');
    const nameModal = document.getElementById('name-modal');
    const passengerNameInput = document.getElementById('passenger-name');
    const confirmNameBtn = document.getElementById('confirm-name');

    // Flight Tracking Elements
    const trackingIndicator = document.getElementById('tracking-indicator');
    const trackingStatus = document.getElementById('tracking-status');
    const zoomLevel = document.getElementById('zoom-level');
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');

    // --- APP STATE ---
    let mode = 'focus';
    let timeRemaining = POMODORO_SETTINGS.focus;
    let isRunning = false;
    let timerId = null;
    let focusSessionsCompleted = 0;
    let currentFlight = null;
    let totalFlightMinutes = 0;
    let selectedSeat = null;
    let selectedClass = null;
    let isFullscreen = false;
    let currentTheme = 'dark';
    let currentMapStyle = 'satellite';
    let showTerrain = false;
    let planeSound = null;
    
    // Flight Tracking State
    let isTracking = true;
    let planeMarker = null;
    let departureMarker = null;
    let arrivalMarker = null;
    let flightPath = null;
    let animationId = null;
    let currentProgress = 0;
    let isPlaying = false;
    let trailDots = [];
    let lastTrailTime = 0;
    let flightStartTime = 0;
    let flightElapsedTime = 0;
    
    // Settings State
    let timerSoundsEnabled = true;
    let planeSoundsEnabled = true;
    
    // Map State
    let map;
    let mapFullscreenInstance;
    let currentTileLayer;
    let fullscreenMapActive = false;

    // --- INITIALIZATION ---
    window.onload = () => {
        loadUserData();
        populateFlightList();
        setupEventListeners();
        updateDisplay();
        updatePomodoroSettingsDisplay();
        createStars();
        initializePlaneSound();
        updateStatistics();
        populateFlightHistory();
        
        // Show name modal on first load
        nameModal.classList.remove('hidden');
    };

    function loadUserData() {
        const savedFlightHistory = localStorage.getItem('focusFlightHistory');
        const savedStats = localStorage.getItem('focusFlightStats');
        const savedSettings = localStorage.getItem('focusFlightSettings');
        const savedName = localStorage.getItem('focusFlightName');
        
        if (savedFlightHistory) flightHistory = JSON.parse(savedFlightHistory);
        if (savedStats) userStats = JSON.parse(savedStats);
        if (savedName) passengerName = savedName;
        
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            timerSoundsEnabled = settings.timerSoundsEnabled !== undefined ? settings.timerSoundsEnabled : true;
            planeSoundsEnabled = settings.planeSoundsEnabled !== undefined ? settings.planeSoundsEnabled : true;
            
            document.getElementById('timer-sounds').checked = timerSoundsEnabled;
            document.getElementById('plane-sounds').checked = planeSoundsEnabled;
        }
    }
    
    function saveUserData() {
        localStorage.setItem('focusFlightHistory', JSON.stringify(flightHistory));
        localStorage.setItem('focusFlightStats', JSON.stringify(userStats));
        localStorage.setItem('focusFlightName', passengerName);
        
        const settings = { timerSoundsEnabled, planeSoundsEnabled };
        localStorage.setItem('focusFlightSettings', JSON.stringify(settings));
    }
    
    function populateFlightHistory() {
        const flightHistoryElement = document.getElementById('flight-history');
        flightHistoryElement.innerHTML = '';
        
        if (flightHistory.length === 0) {
            flightHistoryElement.innerHTML = '<p class="text-slate-400 text-center">No flight history yet</p>';
            return;
        }
        
        const recentFlights = flightHistory.slice(-10).reverse();
        
        recentFlights.forEach(flight => {
            const historyItem = document.createElement('div');
            historyItem.className = 'flight-history-item';
            historyItem.innerHTML = `
                <div>
                    <div class="font-bold">${flight.route}</div>
                    <div class="text-xs text-slate-400">${flight.date}</div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-sky-400">${flight.duration}</div>
                    <div class="text-xs text-slate-400">${flight.passenger}</div>
                </div>
            `;
            flightHistoryElement.appendChild(historyItem);
        });
    }
    
    function updateStatistics() {
        document.getElementById('total-flights').textContent = userStats.totalFlights;
        document.getElementById('total-focus-time').textContent = `${Math.floor(userStats.totalFocusTime / 60)}h`;
        document.getElementById('current-streak').textContent = userStats.currentStreak;
    }
    
    function addFlightToHistory(flight, duration) {
        const now = new Date();
        const dateStr = now.toLocaleDateString();
        
        flightHistory.push({
            route: `${flight.origin} â†’ ${flight.destination}`,
            date: dateStr,
            duration: `${Math.floor(duration / 60)}h ${duration % 60}m`,
            passenger: passengerName
        });
        
        userStats.totalFlights++;
        userStats.totalFocusTime += duration;
        
        const today = new Date().toDateString();
        const lastFlightDate = userStats.lastFlightDate ? new Date(userStats.lastFlightDate).toDateString() : null;
        
        if (lastFlightDate === today) {
            // Already logged a flight today
        } else if (lastFlightDate && (new Date(today) - new Date(lastFlightDate)) / (1000 * 60 * 60 * 24) === 1) {
            userStats.currentStreak++;
        } else {
            userStats.currentStreak = 1;
        }
        
        userStats.lastFlightDate = today;
        
        saveUserData();
        updateStatistics();
        populateFlightHistory();
    }

    function populateFlightList() {
        flightList.innerHTML = '';
        
        FLIGHTS.forEach(flight => {
            const hours = Math.floor(flight.duration / 60);
            const minutes = flight.duration % 60;
            
            const card = document.createElement('div');
            card.className = `flight-card glass-card p-5 rounded-2xl cursor-pointer hover:scale-105 active:scale-100`;
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-lg text-white">${flight.origin} <i class="fas fa-plane text-sky-400 mx-2"></i> ${flight.destination}</p>
                        <p class="text-slate-400">${hours}h ${minutes}m â€¢ ${getFlightType(flight.duration)} â€¢ <i class="fas fa-user text-slate-500"></i> ${getRandomPassengers()}</p>
                    </div>
                    <i class="fas fa-chevron-right text-sky-400 flight-icon"></i>
                </div>
            `;
            
            card.addEventListener('click', () => selectFlight(flight.id));
            
            flightList.appendChild(card);
        });
    }
    
    function getFlightType(duration) {
        if (duration <= 60) return "Short Haul";
        if (duration <= 240) return "Medium Haul";
        if (duration <= 480) return "Long Haul";
        return "Ultra Long Haul";
    }
    
    function getRandomPassengers() {
        const passengers = Math.floor(Math.random() * 100) + 50;
        return `${passengers} passengers`;
    }
    
    function createStars() {
        const container = document.querySelector('body');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = `${Math.random() * 3}px`;
            star.style.height = star.style.width;
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 5}s`;
            container.appendChild(star);
        }
    }
    
    function initializePlaneSound() {
        Tone.start().then(() => {
            planeSound = new Tone.Noise("brown").start();
            const filter = new Tone.Filter(800, "lowpass").toDestination();
            const volume = new Tone.Volume(-30).connect(filter);
            planeSound.connect(volume);
            planeSound.stop();
        });
    }
    
    function playPlaneSound() {
        if (planeSound && planeSoundsEnabled) {
            planeSound.start();
            planeSound.volume.rampTo(-20, 1);
        }
    }
    
    function stopPlaneSound() {
        if (planeSound) {
            planeSound.volume.rampTo(-60, 2);
            setTimeout(() => {
                if (planeSound) planeSound.stop();
            }, 2000);
        }
    }

    // --- VIEW & STATE MANAGEMENT ---
    function selectFlight(flightId) {
        currentFlight = FLIGHTS.find(f => f.id === flightId);
        flightSelectionView.classList.add('hidden-view');
        seatSelectionView.classList.remove('hidden-view');
        
        document.getElementById('seat-flight-route').textContent = `${currentFlight.origin} â†’ ${currentFlight.destination}`;
        
        const hours = Math.floor(currentFlight.duration / 60);
        const minutes = currentFlight.duration % 60;
        document.getElementById('seat-flight-duration').textContent = `${hours}h ${minutes}m`;
        
        renderSeatMap();
    }
    
    function confirmSeat() {
        if (!selectedSeat) return;
        
        seatSelectionView.classList.add('hidden-view');
        boardingPassView.classList.remove('hidden-view');
        generateBoardingPass();
    }
    
    function generateBoardingPass() {
        if (selectedClass === 'first') {
            boardingPass.className = 'pass first';
            document.getElementById('bp-class-tag').textContent = 'FIRST â€¢ LOUNGE';
            document.getElementById('bp-class-display').textContent = 'FIRST';
            document.getElementById('bp-priority').textContent = 'Priority';
            document.getElementById('bp-benefits').textContent = 'Includes chauffeur transfer & priority check-in';
        } else {
            boardingPass.className = 'pass economy';
            document.getElementById('bp-class-tag').textContent = 'ECON';
            document.getElementById('bp-class-display').textContent = 'ECON';
            document.getElementById('bp-priority').textContent = 'Standard';
            document.getElementById('bp-benefits').textContent = 'Baggage allowance: 1x hand luggage';
        }
        
        document.getElementById('bp-ref').textContent = `REF: FOC-${Math.floor(1000 + Math.random() * 9000)}`;
        document.getElementById('bp-passenger').textContent = passengerName;
        
        const originCode = currentFlight.origin.match(/\(([^)]+)\)/)[1];
        const destCode = currentFlight.destination.match(/\(([^)]+)\)/)[1];
        document.getElementById('bp-route').textContent = `${originCode} â†’ ${destCode}`;
        document.getElementById('bp-cities').textContent = `${currentFlight.origin.split(' (')[0]} â€” ${currentFlight.destination.split(' (')[0]}`;
        
        document.getElementById('bp-seat').textContent = selectedSeat;
        document.getElementById('bp-gate').textContent = selectedClass === 'first' ? 'A12' : 'B04';
        
        const now = new Date();
        const boardingTime = new Date(now.getTime() + 30 * 60000);
        const formattedDate = boardingTime.toISOString().split('T')[0].replace(/-/g, '-');
        const formattedTime = boardingTime.toTimeString().slice(0, 5);
        document.getElementById('bp-boarding').textContent = `${formattedTime} â€¢ ${formattedDate}`;
        
        document.getElementById('bp-ticket-code').textContent = `Ticket code: ${Math.floor(100 + Math.random() * 900)}-FOC-${Math.floor(1 + Math.random() * 9)}`;
    }
    
    function startFlight() {
        boardingPassView.classList.add('hidden-view');
        timerView.classList.remove('hidden-view');
        
        totalFlightMinutes = 0;
        focusSessionsCompleted = 0;
        currentProgress = 0;
        flightElapsedTime = 0;
        
        document.getElementById('flight-destination').textContent = currentFlight.destination;
        document.getElementById('flight-origin-code').textContent = currentFlight.origin.match(/\(([^)]+)\)/)[1];
        document.getElementById('flight-dest-code').textContent = currentFlight.destination.match(/\(([^)]+)\)/)[1];
        document.getElementById('flight-origin-code-progress').textContent = currentFlight.origin.match(/\(([^)]+)\)/)[1];
        document.getElementById('flight-dest-code-progress').textContent = currentFlight.destination.match(/\(([^)]+)\)/)[1];
        document.getElementById('seat-display').textContent = selectedSeat;
        document.getElementById('class-display').textContent = selectedClass === 'first' ? 'First Class' : 'Economy';
        
        const hours = Math.floor(currentFlight.duration / 60);
        const minutes = currentFlight.duration % 60;
        document.getElementById('flight-duration').textContent = `${hours}h ${minutes}m`;
        
        updateSessionStats();
        initMap();
        updateFlightProgress();
        resetTimer();
    }
    
    function renderSeatMap() {
        const seatMap = document.getElementById('seat-map');
        seatMap.innerHTML = '';
        
        // First Class Section (Rows 1-4)
        const firstClassSection = document.createElement('div');
        firstClassSection.className = 'cabin-section';
        
        const firstClassLabel = document.createElement('div');
        firstClassLabel.className = 'cabin-label first-class-label';
        firstClassLabel.innerHTML = '<i class="fas fa-crown mr-2"></i> First Class';
        firstClassSection.appendChild(firstClassLabel);
        
        for (let row = 1; row <= 4; row++) {
            const rowElement = createSeatRow(row, true);
            firstClassSection.appendChild(rowElement);
        }
        
        seatMap.appendChild(firstClassSection);
        
        // Divider
        const divider = document.createElement('div');
        divider.className = 'cabin-divider';
        seatMap.appendChild(divider);
        
        // Economy Section (Rows 5-20)
        const economySection = document.createElement('div');
        economySection.className = 'cabin-section';
        
        const economyLabel = document.createElement('div');
        economyLabel.className = 'cabin-label economy-label';
        economyLabel.innerHTML = '<i class="fas fa-users mr-2"></i> Economy Class';
        economySection.appendChild(economyLabel);
        
        for (let row = 5; row <= 20; row++) {
            const rowElement = createSeatRow(row, false);
            economySection.appendChild(rowElement);
        }
        
        seatMap.appendChild(economySection);
    }
    
    function createSeatRow(row, isFirstClass) {
        const rowElement = document.createElement('div');
        rowElement.className = 'seat-row';
        
        // Row number
        const rowNumber = document.createElement('div');
        rowNumber.className = 'row-number';
        rowNumber.textContent = row;
        rowElement.appendChild(rowNumber);
        
        // Left side (A, B, C)
        const leftGroup = document.createElement('div');
        leftGroup.className = 'seat-group';
        
        for (let seatLetter of ['A', 'B', 'C']) {
            const seatId = `${row}${seatLetter}`;
            const seat = createSeat(seatId, seatLetter, isFirstClass);
            leftGroup.appendChild(seat);
        }
        
        rowElement.appendChild(leftGroup);
        
        // Aisle
        const aisleSpace = document.createElement('div');
        aisleSpace.className = 'aisle-space';
        aisleSpace.textContent = 'AISLE';
        rowElement.appendChild(aisleSpace);
        
        // Right side (D, E, F)
        const rightGroup = document.createElement('div');
        rightGroup.className = 'seat-group';
        
        for (let seatLetter of ['D', 'E', 'F']) {
            const seatId = `${row}${seatLetter}`;
            const seat = createSeat(seatId, seatLetter, isFirstClass);
            rightGroup.appendChild(seat);
        }
        
        rowElement.appendChild(rightGroup);
        
        return rowElement;
    }
    
    function createSeat(seatId, seatLetter, isFirstClass) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        if (isFirstClass) {
            seat.classList.add('first-class');
        }
        seat.textContent = seatLetter;
        seat.dataset.id = seatId;
        
        const occupiedChance = isFirstClass ? 0.4 : 0.3;
        if (Math.random() < occupiedChance) {
            seat.classList.add('occupied');
        } else {
            seat.addEventListener('click', () => selectSeat(seatId, isFirstClass));
        }
        
        return seat;
    }
    
    function selectSeat(seatId, isFirstClass) {
        document.querySelectorAll('.seat.selected').forEach(seat => {
            seat.classList.remove('selected');
        });
        
        const seat = document.querySelector(`.seat[data-id="${seatId}"]`);
        seat.classList.add('selected');
        selectedSeat = seatId;
        selectedClass = isFirstClass ? 'first' : 'economy';
        
        document.getElementById('selected-seat-display').textContent = selectedSeat;
        document.getElementById('selected-class-display').textContent = isFirstClass ? 'First Class' : 'Economy';
        document.getElementById('confirm-seat-btn').disabled = false;
    }

    function endFlight() {
        const actualFlightMinutes = totalFlightMinutes;
        addFlightToHistory(currentFlight, actualFlightMinutes);
        
        if(map) { map.remove(); map = null; }
        if(mapFullscreenInstance) { mapFullscreenInstance.remove(); mapFullscreenInstance = null; }
        currentFlight = null;
        selectedSeat = null;
        selectedClass = null;
        timerView.classList.add('hidden-view');
        flightSelectionView.classList.remove('hidden-view');
        pauseTimer();
        switchMode('focus');
        stopPlaneSound();
        
        if (fullscreenMapActive) {
            exitFullscreenMapView();
        }
        
        // Show name modal again for next flight
        nameModal.classList.remove('hidden');
    }
    
    function toggleFullscreenMap() {
        if (!fullscreenMapActive) {
            fullscreenMap.classList.remove('hidden-view');
            timerView.classList.add('hidden-view');
            fullscreenMapActive = true;
            
            initFullscreenMap();
            updateFullscreenTimer();
            updateFullscreenBoardingPass();
        }
    }
    
    function exitFullscreenMapView() {
        fullscreenMap.classList.add('hidden-view');
        timerView.classList.remove('hidden-view');
        fullscreenMapActive = false;
        
        if (mapFullscreenInstance) {
            mapFullscreenInstance.remove();
            mapFullscreenInstance = null;
        }
    }
    
    function initFullscreenMap() {
        if (mapFullscreenInstance) {
            mapFullscreenInstance.remove();
        }
        
        mapFullscreenInstance = L.map('map-fullscreen').setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
        updateFullscreenMapStyle();
        initializeFullscreenTracking();
        addFullscreenWeatherEffects();
        updateFullscreenTimeOfDay(0);
        setupFullscreenMapControls();
    }
    
    function updateFullscreenMapStyle() {
        if (!mapFullscreenInstance) return;
        
        if (currentTileLayer) {
            mapFullscreenInstance.removeLayer(currentTileLayer);
        }
        
        let tileUrl, attribution;
        
        if (currentMapStyle === 'satellite') {
            tileUrl = 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}';
            attribution = '&copy; <a href="https://www.google.com/maps">Google</a>';
        } else if (currentMapStyle === 'street') {
            if (currentTheme === 'dark') {
                tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>';
            } else {
                tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
            }
        } else {
            tileUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
            attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://opentopomap.org">OpenTopoMap</a>';
        }
        
        currentTileLayer = L.tileLayer(tileUrl, {
            attribution: attribution,
            maxZoom: currentMapStyle === 'terrain' ? 17 : 19
        }).addTo(mapFullscreenInstance);
    }
    
    function initializeFullscreenTracking() {
        if (!mapFullscreenInstance) return;
        
        const AirplaneIcon = L.DivIcon.extend({
            options: {
                html: '<div class="airplane-image"></div>',
                className: 'airplane-icon-container',
                iconSize: [40, 40]
            }
        });
        
        // Add departure marker
        L.marker([currentFlight.coords.from[0], currentFlight.coords.from[1]], {
            icon: L.divIcon({
                html: '<div class="airport-marker"></div>',
                iconSize: [20, 20],
                className: 'airport-marker-container'
            })
        }).bindPopup(`<b>Departure:</b> ${currentFlight.origin}`)
          .addTo(mapFullscreenInstance);
        
        // Add arrival marker
        L.marker([currentFlight.coords.to[0], currentFlight.coords.to[1]], {
            icon: L.divIcon({
                html: '<div class="airport-marker" style="background: #FF5722;"></div>',
                iconSize: [20, 20],
                className: 'airport-marker-container'
            })
        }).bindPopup(`<b>Arrival:</b> ${currentFlight.destination}`)
          .addTo(mapFullscreenInstance);
        
        // Add plane marker at departure
        L.marker([currentFlight.coords.from[0], currentFlight.coords.from[1]], {
            icon: new AirplaneIcon()
        }).addTo(mapFullscreenInstance);
        
        mapFullscreenInstance.setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
    }
    
    function addFullscreenWeatherEffects() {
        const weatherOverlay = document.createElement('div');
        weatherOverlay.className = 'weather-overlay';
        document.getElementById('map-fullscreen').appendChild(weatherOverlay);
        
        const weatherTypes = ['cloud', 'cloud-sun', 'cloud-rain', 'snowflake'];
        const curvePoints = calculateGreatCircle(
            currentFlight.coords.from, 
            currentFlight.coords.to,
            20
        );
        
        curvePoints.forEach((point, index) => {
            if (index % 5 === 0) {
                const weatherType = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
                const weatherIcon = document.createElement('i');
                weatherIcon.className = `weather-icon fas fa-${weatherType}`;
                
                const pointPx = mapFullscreenInstance.latLngToContainerPoint(point);
                weatherIcon.style.left = `${pointPx.x}px`;
                weatherIcon.style.top = `${pointPx.y}px`;
                
                weatherOverlay.appendChild(weatherIcon);
            }
        });
    }
    
    function updateFullscreenTimeOfDay(progress) {
        let timeOfDay = document.getElementById('map-fullscreen').querySelector('.time-of-day');
        if (!timeOfDay) {
            timeOfDay = document.createElement('div');
            timeOfDay.className = 'time-of-day';
            document.getElementById('map-fullscreen').appendChild(timeOfDay);
        }
        
        const brightness = 100 - (progress * 70);
        const blueValue = 100 - (progress * 80);
        
        timeOfDay.style.background = `rgba(0, 0, ${blueValue}, ${(100 - brightness) / 200})`;
    }
    
    function setupFullscreenMapControls() {
        const zoomInBtn = document.createElement('button');
        zoomInBtn.innerHTML = '<i class="fas fa-plus"></i>';
        zoomInBtn.title = 'Zoom In';
        zoomInBtn.className = 'map-controls-btn';
        zoomInBtn.addEventListener('click', () => {
            mapFullscreenInstance.zoomIn();
        });
        
        const zoomOutBtn = document.createElement('button');
        zoomOutBtn.innerHTML = '<i class="fas fa-minus"></i>';
        zoomOutBtn.title = 'Zoom Out';
        zoomOutBtn.className = 'map-controls-btn';
        zoomOutBtn.addEventListener('click', () => {
            mapFullscreenInstance.zoomOut();
        });
        
        const resetViewBtn = document.createElement('button');
        resetViewBtn.innerHTML = '<i class="fas fa-crosshairs"></i>';
        resetViewBtn.title = 'Reset View';
        resetViewBtn.className = 'map-controls-btn';
        resetViewBtn.addEventListener('click', () => {
            mapFullscreenInstance.setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
        });
        
        const controlsContainer = document.createElement('div');
        controlsContainer.className = 'map-controls';
        controlsContainer.appendChild(zoomInBtn);
        controlsContainer.appendChild(zoomOutBtn);
        controlsContainer.appendChild(resetViewBtn);
        
        document.getElementById('map-fullscreen').appendChild(controlsContainer);
    }
    
    function updateFullscreenTimer() {
        const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
        const seconds = Math.floor(timeRemaining % 60).toString().padStart(2, '0');
        fullscreenTimer.textContent = `${minutes}:${seconds}`;
    }
    
    function updateFullscreenBoardingPass() {
        const passHTML = `
            <div class="pass ${selectedClass === 'first' ? 'first' : 'economy'}">
                <div class="left">
                    <div>
                        <div class="brand">
                            <div class="logo">FO</div>
                            <div>
                                <h3>Focus Airlines â€” ${selectedClass === 'first' ? 'First' : 'Economy'}</h3>
                                <p>${selectedClass === 'first' ? 'Concierge boarding Â· Lounge access Â· Extra baggage' : 'Standard boarding Â· Carry-on luggage'}</p>
                            </div>
                            <div style="margin-left:auto; text-align:right">
                                <div class="tag">${selectedClass === 'first' ? 'FIRST â€¢ LOUNGE' : 'ECON'}</div>
                                <div style="font-size:12px; color:var(--muted); margin-top:6px">REF: FOC-${Math.floor(1000 + Math.random() * 9000)}</div>
                            </div>
                        </div>

                        <div style="margin-top:18px; display:flex; justify-content:space-between; align-items:center">
                            <div>
                                <div class="route">
                                    <div>
                                        <div class="code">${currentFlight.origin.match(/\(([^)]+)\)/)[1]} â†’ ${currentFlight.destination.match(/\(([^)]+)\)/)[1]}</div>
                                        <div class="city">${currentFlight.origin.split(' (')[0]} â€” ${currentFlight.destination.split(' (')[0]}</div>
                                    </div>
                                </div>
                                <div class="meta">
                                    <div class="item"><div class="label">Passenger</div><div class="value">${passengerName}</div></div>
                                    <div class="item"><div class="label">Seat</div><div class="value">${selectedSeat}</div></div>
                                    <div class="item"><div class="label">Gate</div><div class="value">${selectedClass === 'first' ? 'A12' : 'B04'}</div></div>
                                    <div class="item"><div class="label">Boarding</div><div class="value">${new Date().toTimeString().slice(0, 5)} â€¢ ${new Date().toISOString().split('T')[0].replace(/-/g, '-')}</div></div>
                                </div>
                            </div>

                            <div style="text-align:right">
                                <div style="font-size:12px; color:var(--muted)">Class</div>
                                <div style="font-size:22px; font-weight:900; color:var(--gold)">${selectedClass === 'first' ? 'FIRST' : 'ECON'}</div>
                                <div style="margin-top:8px; font-weight:700">${selectedClass === 'first' ? 'Priority' : 'Standard'}</div>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px">
                        <div class="footer-note">${selectedClass === 'first' ? 'Includes chauffeur transfer & priority check-in' : 'Baggage allowance: 1x hand luggage'}</div>
                        <div class="footer-note muted">Ticket code: ${Math.floor(100 + Math.random() * 900)}-FOC-${Math.floor(1 + Math.random() * 9)}</div>
                    </div>
                </div>

                <div class="right">
                    <div style="align-self:stretch; display:flex; flex-direction:column; justify-content:space-between; gap:12px; align-items:flex-end;">
                        <div style="width:100%; display:flex; justify-content:flex-end">
                            <div class="qr" aria-hidden="true">QR</div>
                        </div>

                        <div style="width:100%; display:flex; justify-content:flex-end; gap:10px;">
                            <div style="text-align:right">
                                <div class="label muted">Pax type</div>
                                <div class="value">ADULT</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="perforation" aria-hidden="true"></div>
            </div>
        `;
        
        fullscreenBoardingPass.innerHTML = passHTML;
    }
    
    function toggleTheme(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-mode');
            lightModeBtn.classList.add('active');
            darkModeBtn.classList.remove('active');
            currentTheme = 'light';
        } else {
            document.body.classList.remove('light-mode');
            darkModeBtn.classList.add('active');
            lightModeBtn.classList.remove('active');
            currentTheme = 'dark';
        }
        
        if (map) updateMapStyle();
        if (mapFullscreenInstance) updateFullscreenMapStyle();
    }
    
    function toggleMapStyle(style) {
        currentMapStyle = style;
        
        mapTypeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.type === style) {
                btn.classList.add('active');
            }
        });
        
        updateMapStyle();
        
        if (mapFullscreenInstance) {
            updateFullscreenMapStyle();
        }
    }

    // --- FLIGHT TRACKING MECHANISM ---
    function initializeTracking() {
        const AirplaneIcon = L.DivIcon.extend({
            options: {
                html: '<div class="airplane-image"></div>',
                className: 'airplane-icon-container',
                iconSize: [40, 40]
            }
        });
        
        // Add departure marker
        departureMarker = L.marker([currentFlight.coords.from[0], currentFlight.coords.from[1]], {
            icon: L.divIcon({
                html: '<div class="airport-marker"></div>',
                iconSize: [20, 20],
                className: 'airport-marker-container'
            })
        }).bindPopup(`<b>Departure:</b> ${currentFlight.origin}`)
          .addTo(map);
        
        // Add arrival marker
        arrivalMarker = L.marker([currentFlight.coords.to[0], currentFlight.coords.to[1]], {
            icon: L.divIcon({
                html: '<div class="airport-marker" style="background: #FF5722;"></div>',
                iconSize: [20, 20],
                className: 'airport-marker-container'
            })
        }).bindPopup(`<b>Arrival:</b> ${currentFlight.destination}`)
          .addTo(map);
        
        // Add plane marker at departure (very zoomed in)
        planeMarker = L.marker([currentFlight.coords.from[0], currentFlight.coords.from[1]], {
            icon: new AirplaneIcon()
        }).addTo(map);
        
        // Start VERY zoomed in on the departure airport
        map.setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
        
        // Initialize tracking indicator
        updateTrackingIndicator();
    }
    
    function animateFlight() {
        if (!isPlaying) return;
        
        const now = Date.now();
        const deltaTime = now - flightStartTime;
        flightElapsedTime += deltaTime;
        flightStartTime = now;
        
        // Calculate progress based on elapsed time and total flight duration
        const totalFlightTimeMs = currentFlight.duration * 60 * 1000;
        currentProgress = Math.min(flightElapsedTime / totalFlightTimeMs, 1);
        
        // Calculate current position
        const currentLat = currentFlight.coords.from[0] + (currentFlight.coords.to[0] - currentFlight.coords.from[0]) * currentProgress;
        const currentLng = currentFlight.coords.from[1] + (currentFlight.coords.to[1] - currentFlight.coords.from[1]) * currentProgress;
        
        // Update plane position
        if (planeMarker) {
            planeMarker.setLatLng([currentLat, currentLng]);
            
            // Calculate rotation angle
            const dx = currentFlight.coords.to[1] - currentFlight.coords.from[1];
            const dy = currentFlight.coords.to[0] - currentFlight.coords.from[0];
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            // Update plane rotation
            const iconElement = planeMarker.getElement();
            if (iconElement) {
                const div = iconElement.querySelector('.airplane-image');
                if (div) {
                    div.style.transform = `rotate(${angle}deg)`;
                }
            }
            
            // Add trail dots
            if (now - lastTrailTime > 1000) {
                addTrailDot([currentLat, currentLng]);
                lastTrailTime = now;
            }
            
            // Update tracking if enabled
            if (isTracking) {
                centerMapOnPlane();
            }
        }
        
        // Update flight progress display
        updateFlightProgress();
        
        // Continue animation if not complete
        if (currentProgress < 1) {
            animationId = requestAnimationFrame(animateFlight);
        }
    }
    
    function addTrailDot(position) {
        const trailContainer = document.getElementById('plane-trail');
        const dot = document.createElement('div');
        dot.className = 'trail-dot';
        
        // Convert lat/lng to pixel position
        const pointPx = map.latLngToContainerPoint(position);
        dot.style.left = `${pointPx.x}px`;
        dot.style.top = `${pointPx.y}px`;
        
        trailContainer.appendChild(dot);
        trailDots.push(dot);
        
        // Limit the number of trail dots to prevent performance issues
        if (trailDots.length > 20) {
            const oldDot = trailDots.shift();
            if (oldDot && oldDot.parentNode) {
                oldDot.parentNode.removeChild(oldDot);
            }
        }
        
        // Fade out trail dots over time
        setTimeout(() => {
            if (dot.parentNode) {
                dot.style.opacity = '0.5';
            }
        }, 1000);
        
        setTimeout(() => {
            if (dot.parentNode) {
                dot.style.opacity = '0.2';
            }
        }, 2000);
        
        setTimeout(() => {
            if (dot.parentNode) {
                dot.parentNode.removeChild(dot);
                const index = trailDots.indexOf(dot);
                if (index > -1) {
                    trailDots.splice(index, 1);
                }
            }
        }, 3000);
    }
    
    function updateTrackingIndicator() {
        if (isTracking) {
            trackingIndicator.classList.remove('tracking-off');
            trackingStatus.textContent = 'ON';
        } else {
            trackingIndicator.classList.add('tracking-off');
            trackingStatus.textContent = 'OFF';
        }
    }
    
    function centerMapOnPlane() {
        if (planeMarker && isTracking) {
            map.setView(planeMarker.getLatLng(), map.getZoom());
        }
    }

    // --- MAP LOGIC ---
    function initMap() {
        if (map) map.remove();

        // Start VERY zoomed in on the departure airport
        map = L.map('map').setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
        
        // Set up map style
        updateMapStyle();
        
        // Initialize flight tracking
        initializeTracking();
        
        // Add weather effects
        addWeatherEffects();
        
        // Set time of day based on flight progress
        updateTimeOfDay(0);
        
        // Calculate and display flight distance
        updateFlightDistance();
        
        // Add map controls
        setupMapControls();
        
        // Add zoom event listener to adjust city visibility
        map.on('zoomend', function() {
            zoomLevel.textContent = map.getZoom();
        });
    }
    
    function updateMapStyle() {
        if (!map) return;
        
        if (currentTileLayer) {
            map.removeLayer(currentTileLayer);
        }
        
        let tileUrl, attribution;
        
        if (currentMapStyle === 'satellite') {
            tileUrl = 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}';
            attribution = '&copy; <a href="https://www.google.com/maps">Google</a>';
        } else if (currentMapStyle === 'street') {
            if (currentTheme === 'dark') {
                tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>';
            } else {
                tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
            }
        } else {
            tileUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
            attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://opentopomap.org">OpenTopoMap</a>';
        }
        
        currentTileLayer = L.tileLayer(tileUrl, {
            attribution: attribution,
            maxZoom: currentMapStyle === 'terrain' ? 17 : 19
        }).addTo(map);
    }
    
    function addWeatherEffects() {
        const weatherOverlay = document.getElementById('weather-overlay');
        weatherOverlay.innerHTML = '';
        
        const weatherTypes = ['cloud', 'cloud-sun', 'cloud-rain', 'snowflake'];
        const curvePoints = calculateGreatCircle(
            currentFlight.coords.from, 
            currentFlight.coords.to,
            20
        );
        
        curvePoints.forEach((point, index) => {
            if (index % 5 === 0) {
                const weatherType = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
                const weatherIcon = document.createElement('i');
                weatherIcon.className = `weather-icon fas fa-${weatherType}`;
                
                const pointPx = map.latLngToContainerPoint(point);
                weatherIcon.style.left = `${pointPx.x}px`;
                weatherIcon.style.top = `${pointPx.y}px`;
                
                weatherOverlay.appendChild(weatherIcon);
            }
        });
    }
    
    function updateTimeOfDay(progress) {
        const timeOfDay = document.getElementById('time-of-day');
        
        const brightness = 100 - (progress * 70);
        const blueValue = 100 - (progress * 80);
        
        timeOfDay.style.background = `rgba(0, 0, ${blueValue}, ${(100 - brightness) / 200})`;
    }
    
    function updateFlightDistance() {
        // Calculate approximate distance in km
        const R = 6371;
        const lat1 = currentFlight.coords.from[0] * Math.PI / 180;
        const lon1 = currentFlight.coords.from[1] * Math.PI / 180;
        const lat2 = currentFlight.coords.to[0] * Math.PI / 180;
        const lon2 = currentFlight.coords.to[1] * Math.PI / 180;
        
        const dLat = lat2 - lat1;
        const dLon = lon2 - lon1;
        
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        const remainingDistance = Math.round(distance * (1 - currentProgress));
        
        document.getElementById('map-distance').textContent = `Distance: ${remainingDistance} km`;
        
        const now = new Date();
        const remainingTimeMs = (1 - currentProgress) * (currentFlight.duration * 60 * 1000);
        const eta = new Date(now.getTime() + remainingTimeMs);
        const etaTime = eta.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        document.getElementById('flight-eta').textContent = `ETA: ${etaTime}`;
    }
    
    function setupMapControls() {
        document.getElementById('zoom-in-btn').addEventListener('click', () => {
            map.zoomIn();
        });
        
        document.getElementById('zoom-out-btn').addEventListener('click', () => {
            map.zoomOut();
        });
        
        document.getElementById('reset-view-btn').addEventListener('click', () => {
            map.setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
        });
        
        document.getElementById('toggle-map-btn').addEventListener('click', () => {
            if (currentMapStyle === 'satellite') {
                toggleMapStyle('street');
            } else if (currentMapStyle === 'street') {
                toggleMapStyle('terrain');
            } else {
                toggleMapStyle('satellite');
            }
        });
    }
    
    function calculateGreatCircle(start, end, numPoints) {
        const points = [];
        
        // Convert to radians
        const lat1 = start[0] * Math.PI / 180;
        const lon1 = start[1] * Math.PI / 180;
        const lat2 = end[0] * Math.PI / 180;
        const lon2 = end[1] * Math.PI / 180;
        
        // Calculate great circle points
        for (let i = 0; i <= numPoints; i++) {
            const f = i / numPoints;
            const A = Math.sin((1 - f) * distance(start, end)) / Math.sin(distance(start, end));
            const B = Math.sin(f * distance(start, end)) / Math.sin(distance(start, end));
            const x = A * Math.cos(lat1) * Math.cos(lon1) + B * Math.cos(lat2) * Math.cos(lon2);
            const y = A * Math.cos(lat1) * Math.sin(lon1) + B * Math.cos(lat2) * Math.sin(lon2);
            const z = A * Math.sin(lat1) + B * Math.sin(lat2);
            
            const lat = Math.atan2(z, Math.sqrt(x*x + y*y)) * 180 / Math.PI;
            const lon = Math.atan2(y, x) * 180 / Math.PI;
            
            points.push([lat, lon]);
        }
        
        return points;
    }
    
    function distance(point1, point2) {
        const lat1 = point1[0] * Math.PI / 180;
        const lon1 = point1[1] * Math.PI / 180;
        const lat2 = point2[0] * Math.PI / 180;
        const lon2 = point2[1] * Math.PI / 180;
        
        return Math.acos(
            Math.sin(lat1) * Math.sin(lat2) + 
            Math.cos(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1)
        );
    }

    function updateFlightProgress() {
        const progressPercent = Math.round(currentProgress * 100);
        document.getElementById('flight-progress-bar').style.width = `${progressPercent}%`;
        document.getElementById('flight-progress-text').textContent = `${progressPercent}%`;
        document.getElementById('map-progress').textContent = `Progress: ${progressPercent}%`;
        
        updateTimeOfDay(currentProgress);
        updateFlightDistance();
        
        totalFlightMinutes = currentProgress * currentFlight.duration;
        updateSessionStats();
        
        if (fullscreenMapActive) {
            updateFullscreenTimer();
            updateFullscreenTimeOfDay(currentProgress);
        }
    }
    
    function updateSessionStats() {
        document.getElementById('completed-sessions').textContent = focusSessionsCompleted;
        document.getElementById('flight-progress-minutes').textContent = Math.floor(totalFlightMinutes);
        document.getElementById('flight-progress-percent').textContent = `${Math.min(Math.round((totalFlightMinutes / currentFlight.duration) * 100), 100)}%`;
        
        const remainingMinutes = Math.max(0, currentFlight.duration - totalFlightMinutes);
        const hours = Math.floor(remainingMinutes / 60);
        const minutes = Math.floor(remainingMinutes % 60);
        document.getElementById('flight-remaining').textContent = `${hours}h ${minutes}m`;
    }

    // --- TIMER LOGIC ---
    function updateDisplay() {
        const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
        const seconds = Math.floor(timeRemaining % 60).toString().padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
        
        const circumference = 703;
        const progress = 1 - (timeRemaining / POMODORO_SETTINGS[mode]);
        const offset = circumference - (progress * circumference);
        progressCircle.style.strokeDashoffset = offset;
        
        const modeText = mode.replace('B', ' B');
        document.title = `${minutes}:${seconds} - ${modeText.charAt(0).toUpperCase() + modeText.slice(1)}`;
        
        if (fullscreenMapActive) {
            updateFullscreenTimer();
        }
    }

    function startTimer() {
        if (isRunning) return;
        isRunning = true;
        startPauseBtn.classList.add('from-sky-600', 'to-cyan-500');
        startPauseBtn.classList.remove('from-sky-500', 'to-cyan-400');
        document.getElementById('play-icon').classList.add('hidden');
        document.getElementById('pause-icon').classList.remove('hidden');

        if (mode === 'focus') {
            startFlightAnimation();
        }
        
        playPlaneSound();
        
        timerId = setInterval(() => {
            timeRemaining--;
            updateDisplay();
            
            if (timeRemaining <= 0) { 
                handleSessionEnd(); 
            }
        }, 1000);
    }
    
    function startFlightAnimation() {
        if (!isPlaying) {
            isPlaying = true;
            flightStartTime = Date.now();
            animateFlight();
        }
    }
    
    function pauseFlightAnimation() {
        isPlaying = false;
        if (animationId) {
            cancelAnimationFrame(animationId);
        }
    }
    
    function pauseTimer() {
        if (!isRunning) return;
        isRunning = false;
        startPauseBtn.classList.remove('from-sky-600', 'to-cyan-500');
        startPauseBtn.classList.add('from-sky-500', 'to-cyan-400');
        document.getElementById('pause-icon').classList.add('hidden');
        document.getElementById('play-icon').classList.remove('hidden');
        clearInterval(timerId);
        
        pauseFlightAnimation();
        stopPlaneSound();
    }

    function resetTimer() {
        pauseTimer();
        timeRemaining = POMODORO_SETTINGS[mode];
        updateDisplay();
        
        currentProgress = 0;
        flightElapsedTime = 0;
        updateFlightProgress();
        
        if (planeMarker) {
            planeMarker.setLatLng([currentFlight.coords.from[0], currentFlight.coords.from[1]]);
        }
        
        const trailContainer = document.getElementById('plane-trail');
        trailContainer.innerHTML = '';
        trailDots = [];
        
        if (map) {
            map.setView([currentFlight.coords.from[0], currentFlight.coords.from[1]], 15);
        }
    }
    
    function switchMode(newMode) {
        mode = newMode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${newMode}Btn`).classList.add('active');
        
        timeRemaining = POMODORO_SETTINGS[mode];
        updateDisplay();
    }
    
    function handleSessionEnd() {
        if (timerSoundsEnabled) {
            playSound();
        }
        
        if (mode === 'focus') {
            totalFlightMinutes += (POMODORO_SETTINGS.focus / 60);
            focusSessionsCompleted++;
            showNotification("Focus session complete! Time for a break.");
            
            if (focusSessionsCompleted % POMODORO_SETTINGS.sessionsBeforeLongBreak === 0) {
                switchMode('longBreak');
            } else {
                switchMode('shortBreak');
            }
        } else {
            showNotification("Break time over! Ready for another focus session?");
            switchMode('focus');
        }
        startTimer();
    }
    
    function playSound() {
        Tone.start().then(() => {
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C5", "8n", Tone.now());
            synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
        });
    }
    
    function showNotification(message) {
        notificationText.textContent = message;
        notification.classList.remove('hidden');
        
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 5000);
    }
    
    // --- POMODORO SETTINGS ---
    function updatePomodoroSettings(focus, shortBreak, longBreak = 15, sessions = 4) {
        POMODORO_SETTINGS = {
            focus: focus * 60,
            shortBreak: shortBreak * 60,
            longBreak: longBreak * 60,
            sessionsBeforeLongBreak: sessions
        };
        
        if (isRunning && mode === 'focus') {
            timeRemaining = POMODORO_SETTINGS.focus;
        } else if (isRunning && mode === 'shortBreak') {
            timeRemaining = POMODORO_SETTINGS.shortBreak;
        } else if (isRunning && mode === 'longBreak') {
            timeRemaining = POMODORO_SETTINGS.longBreak;
        } else {
            timeRemaining = POMODORO_SETTINGS[mode];
        }
        
        updateDisplay();
        updatePomodoroSettingsDisplay();
    }
    
    function updatePomodoroSettingsDisplay() {
        const focusMins = POMODORO_SETTINGS.focus / 60;
        const breakMins = POMODORO_SETTINGS.shortBreak / 60;
        pomodoroSettingsDisplay.textContent = `${focusMins}/${breakMins} Pomodoro`;
    }
    
    // --- SETTINGS PANEL ---
    function openSettings() {
        settingsPanel.classList.add('open');
        settingsOverlay.classList.add('active');
    }
    
    function closeSettingsPanel() {
        settingsPanel.classList.remove('open');
        settingsOverlay.classList.remove('active');
    }
    
    function resetAllData() {
        if (confirm("Are you sure you want to reset all data? This action cannot be undone.")) {
            localStorage.clear();
            location.reload();
        }
    }
    
    function exportData() {
        const data = {
            flightHistory,
            userStats,
            passengerName
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'focusflight-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification("Data exported successfully!");
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Name modal
        confirmNameBtn.addEventListener('click', () => {
            const name = passengerNameInput.value.trim();
            if (name) {
                passengerName = name;
                localStorage.setItem('focusFlightName', passengerName);
                nameModal.classList.add('hidden');
            } else {
                passengerNameInput.focus();
            }
        });
        
        passengerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmNameBtn.click();
            }
        });
        
        // Mode buttons
        document.getElementById('focusBtn').addEventListener('click', () => switchMode('focus'));
        document.getElementById('shortBreakBtn').addEventListener('click', () => switchMode('shortBreak'));
        document.getElementById('longBreakBtn').addEventListener('click', () => switchMode('longBreak'));

        // Timer controls
        startPauseBtn.addEventListener('click', () => isRunning ? pauseTimer() : startTimer());
        resetBtn.addEventListener('click', resetTimer);
        endFlightBtn.addEventListener('click', endFlight);
        
        // Seat selection
        document.getElementById('confirm-seat-btn').addEventListener('click', confirmSeat);
        
        // Boarding pass
        startFlightBtn.addEventListener('click', startFlight);
        
        // Fullscreen map
        fullscreenMapBtn.addEventListener('click', toggleFullscreenMap);
        exitFullscreenMap.addEventListener('click', exitFullscreenMapView);
        
        // Map type buttons
        mapTypeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.type) {
                    toggleMapStyle(btn.dataset.type);
                }
            });
        });
        
        // Theme toggle
        lightModeBtn.addEventListener('click', () => toggleTheme('light'));
        darkModeBtn.addEventListener('click', () => toggleTheme('dark'));
        
        // Pomodoro settings
        document.querySelectorAll('.pomodoro-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.pomodoro-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                if (this.dataset.focus === 'custom') {
                    document.getElementById('custom-settings').classList.remove('hidden');
                } else {
                    document.getElementById('custom-settings').classList.add('hidden');
                    updatePomodoroSettings(
                        parseInt(this.dataset.focus),
                        parseInt(this.dataset.break)
                    );
                }
            });
        });
        
        // Custom settings
        document.getElementById('apply-custom').addEventListener('click', function() {
            const focus = parseInt(document.getElementById('custom-focus').value);
            const shortBreak = parseInt(document.getElementById('custom-break').value);
            const longBreak = parseInt(document.getElementById('custom-long-break').value);
            const sessions = parseInt(document.getElementById('custom-sessions').value);
            
            updatePomodoroSettings(focus, shortBreak, longBreak, sessions);
            
            document.querySelectorAll('.pomodoro-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.pomodoro-btn[data-focus="custom"]').classList.add('active');
        });
        
        // Flight Tracking Controls
        trackingIndicator.addEventListener('click', function() {
            isTracking = !isTracking;
            updateTrackingIndicator();
            
            if (isTracking && isPlaying) {
                centerMapOnPlane();
            }
        });
        
        // Zoom controls
        zoomInBtn.addEventListener('click', function() {
            map.zoomIn();
        });
        
        zoomOutBtn.addEventListener('click', function() {
            map.zoomOut();
        });
        
        // Settings panel
        settingsBtn.addEventListener('click', openSettings);
        closeSettings.addEventListener('click', closeSettingsPanel);
        settingsOverlay.addEventListener('click', closeSettingsPanel);
        
        // Sound settings
        document.getElementById('timer-sounds').addEventListener('change', function() {
            timerSoundsEnabled = this.checked;
            saveUserData();
        });
        
        document.getElementById('plane-sounds').addEventListener('change', function() {
            planeSoundsEnabled = this.checked;
            saveUserData();
            
            if (!planeSoundsEnabled && planeSound) {
                stopPlaneSound();
            }
        });
        
        // Data management
        document.getElementById('export-data').addEventListener('click', exportData);
        document.getElementById('reset-data').addEventListener('click', resetAllData);
    }
</script>

</body>
</html>